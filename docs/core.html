---

title: Core


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/core.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev</span> <span class="kn">import</span> <span class="n">show_doc</span><span class="p">,</span> <span class="n">test_eq</span><span class="p">,</span> <span class="n">test_fail</span><span class="p">,</span> <span class="n">test_warns</span>
<span class="kn">from</span> <span class="nn">window_ops.expanding</span> <span class="kn">import</span> <span class="n">expanding_mean</span>
<span class="kn">from</span> <span class="nn">window_ops.rolling</span> <span class="kn">import</span> <span class="n">rolling_mean</span>

<span class="kn">from</span> <span class="nn">mlforecast.utils</span> <span class="kn">import</span> <span class="n">generate_daily_series</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Data-format">Data format<a class="anchor-link" href="#Data-format"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The required input format is a dataframe with an index named <code>unique_id</code> with a unique identifier for each time serie, a column <code>ds</code> with the datestamp and a column <code>y</code> with the values of the serie. Every other column is considered a static feature unless stated otherwise in <a href="/mlforecast/core.html#TimeSeries.fit"><code>TimeSeries.fit</code></a></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">series</span> <span class="o">=</span> <span class="n">generate_daily_series</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">n_static_features</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">series</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ds</th>
      <th>y</th>
      <th>static_0</th>
      <th>static_1</th>
    </tr>
    <tr>
      <th>unique_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>id_00</th>
      <td>2000-01-01</td>
      <td>2.380027</td>
      <td>49</td>
      <td>79</td>
    </tr>
    <tr>
      <th>id_00</th>
      <td>2000-01-02</td>
      <td>11.556201</td>
      <td>49</td>
      <td>79</td>
    </tr>
    <tr>
      <th>id_00</th>
      <td>2000-01-03</td>
      <td>22.165185</td>
      <td>49</td>
      <td>79</td>
    </tr>
    <tr>
      <th>id_00</th>
      <td>2000-01-04</td>
      <td>27.319662</td>
      <td>49</td>
      <td>79</td>
    </tr>
    <tr>
      <th>id_00</th>
      <td>2000-01-05</td>
      <td>36.392082</td>
      <td>49</td>
      <td>79</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>id_19</th>
      <td>2000-03-25</td>
      <td>8.175649</td>
      <td>12</td>
      <td>81</td>
    </tr>
    <tr>
      <th>id_19</th>
      <td>2000-03-26</td>
      <td>10.995813</td>
      <td>12</td>
      <td>81</td>
    </tr>
    <tr>
      <th>id_19</th>
      <td>2000-03-27</td>
      <td>12.657186</td>
      <td>12</td>
      <td>81</td>
    </tr>
    <tr>
      <th>id_19</th>
      <td>2000-03-28</td>
      <td>0.420927</td>
      <td>12</td>
      <td>81</td>
    </tr>
    <tr>
      <th>id_19</th>
      <td>2000-03-29</td>
      <td>2.888024</td>
      <td>12</td>
      <td>81</td>
    </tr>
  </tbody>
</table>
<p>4874 rows × 4 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For simplicity we'll just take one time serie here.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">uids</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;unique_id&#39;</span><span class="p">)</span>
<span class="n">serie</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">uids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
<span class="n">serie</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ds</th>
      <th>y</th>
      <th>static_0</th>
      <th>static_1</th>
    </tr>
    <tr>
      <th>unique_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>id_00</th>
      <td>2000-01-01</td>
      <td>2.380027</td>
      <td>49</td>
      <td>79</td>
    </tr>
    <tr>
      <th>id_00</th>
      <td>2000-01-02</td>
      <td>11.556201</td>
      <td>49</td>
      <td>79</td>
    </tr>
    <tr>
      <th>id_00</th>
      <td>2000-01-03</td>
      <td>22.165185</td>
      <td>49</td>
      <td>79</td>
    </tr>
    <tr>
      <th>id_00</th>
      <td>2000-01-04</td>
      <td>27.319662</td>
      <td>49</td>
      <td>79</td>
    </tr>
    <tr>
      <th>id_00</th>
      <td>2000-01-05</td>
      <td>36.392082</td>
      <td>49</td>
      <td>79</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>id_00</th>
      <td>2000-08-05</td>
      <td>4.263168</td>
      <td>49</td>
      <td>79</td>
    </tr>
    <tr>
      <th>id_00</th>
      <td>2000-08-06</td>
      <td>12.288851</td>
      <td>49</td>
      <td>79</td>
    </tr>
    <tr>
      <th>id_00</th>
      <td>2000-08-07</td>
      <td>19.142737</td>
      <td>49</td>
      <td>79</td>
    </tr>
    <tr>
      <th>id_00</th>
      <td>2000-08-08</td>
      <td>27.959904</td>
      <td>49</td>
      <td>79</td>
    </tr>
    <tr>
      <th>id_00</th>
      <td>2000-08-09</td>
      <td>38.331903</td>
      <td>49</td>
      <td>79</td>
    </tr>
  </tbody>
</table>
<p>222 rows × 4 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="simple_predict" class="doc_header"><code>simple_predict</code><a href="https://github.com/Nixtla/mlforecast/tree/main/mlforecast/core.py#L153" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>simple_predict</code>(<strong><code>model</code></strong>, <strong><code>new_x</code></strong>:<code>DataFrame</code>, <strong>*<code>args</code></strong>)</p>
</blockquote>
<p>Drop the ds column from <code>new_x</code> and call <code>model.predict</code> on it.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TimeSeries" class="doc_header"><code>class</code> <code>TimeSeries</code><a href="https://github.com/Nixtla/mlforecast/tree/main/mlforecast/core.py#L168" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TimeSeries</code>(<strong><code>freq</code></strong>:<code>str</code>=<em><code>'D'</code></em>, <strong><code>lags</code></strong>:<code>List</code>[<code>int</code>]=<em><code>[]</code></em>, <strong><code>lag_transforms</code></strong>:<code>Dict</code>[<code>int</code>, <code>List</code>[<code>Tuple</code>]]=<em><code>{}</code></em>, <strong><code>date_features</code></strong>:<code>List</code>[<code>str</code>]=<em><code>[]</code></em>, <strong><code>num_threads</code></strong>:<code>Optional</code>[<code>int</code>]=<em><code>None</code></em>)</p>
</blockquote>
<p>Utility class for storing and transforming time series data.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <a href="/mlforecast/core.html#TimeSeries"><code>TimeSeries</code></a> class takes care of defining the transformations to be performed (<code>lags</code>, <code>lag_transforms</code> and <code>date_features</code>). The transformations can be computed using multithreading if <code>num_threads &gt; 1</code>. If <code>num_threads=None</code> then it is set to the number of cpus using <code>os.cpu_count()</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">flow_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;W-THU&#39;</span><span class="p">,</span>
    <span class="n">lags</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
    <span class="n">lag_transforms</span><span class="o">=</span><span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="n">expanding_mean</span><span class="p">,</span> <span class="p">(</span><span class="n">rolling_mean</span><span class="p">,</span> <span class="mi">7</span><span class="p">)]</span>
    <span class="p">},</span>
    <span class="n">date_features</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dayofweek&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">ts</span> <span class="o">=</span> <span class="n">TimeSeries</span><span class="p">(</span><span class="o">**</span><span class="n">flow_config</span><span class="p">)</span>
<span class="n">ts</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>TimeSeries(freq=&lt;Week: weekday=3&gt;, transforms=[&#39;lag-7&#39;, &#39;expanding_mean_lag-1&#39;, &#39;rolling_mean_lag-1_window_size-7&#39;], date_features=[&#39;dayofweek&#39;], num_threads=8)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The frequency is converted to an offset.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">frequencies</span><span class="o">.</span><span class="n">to_offset</span><span class="p">(</span><span class="n">flow_config</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The date features are stored as they were passed to the constructor.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">date_features</span><span class="p">,</span> <span class="n">flow_config</span><span class="p">[</span><span class="s1">&#39;date_features&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The transformations are stored as a dictionary where the key is the name of the transformation (name of the column in the dataframe with the computed features), which is built using <code>build_transform_name</code> and the value is a tuple where the first element is the lag it is applied to, then the function and then the function arguments.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">transforms</span><span class="p">,</span> 
    <span class="p">{</span>
        <span class="s1">&#39;lag-7&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">_identity</span><span class="p">),</span>
        <span class="s1">&#39;expanding_mean_lag-1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">expanding_mean</span><span class="p">),</span> 
        <span class="s1">&#39;rolling_mean_lag-1_window_size-7&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">rolling_mean</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
        
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Note that for <code>lags</code> we define the transformation as the identity function applied to its corresponding lag. This is because <code>_transform_series</code> takes the lag as an argument and shifts the array before computing the transformation.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TimeSeries.fit_transform" class="doc_header"><code>TimeSeries.fit_transform</code><a href="https://github.com/Nixtla/mlforecast/tree/main/mlforecast/core.py#L352" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TimeSeries.fit_transform</code>(<strong><code>data</code></strong>:<code>DataFrame</code>, <strong><code>static_features</code></strong>:<code>Optional</code>[<code>List</code>[<code>str</code>]]=<em><code>None</code></em>, <strong><code>dropna</code></strong>:<code>bool</code>=<em><code>True</code></em>, <strong><code>keep_last_n</code></strong>:<code>Optional</code>[<code>int</code>]=<em><code>None</code></em>)</p>
</blockquote>
<p>Add the features to <code>data</code> and save the required information for the predictions step.</p>
<p>If not all features are static, specif which ones are in <code>static_features</code>.
If you don't want to drop rows with null values after the transformations set <code>dropna=False</code>.
If you want to keep only the last <code>n</code> values of each time serie set <code>keep_last_n=n</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">flow_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span>
    <span class="n">lags</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">],</span>
    <span class="n">lag_transforms</span><span class="o">=</span><span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="n">expanding_mean</span><span class="p">],</span>
        <span class="mi">2</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">rolling_mean</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
            <span class="p">(</span><span class="n">rolling_mean</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="n">date_features</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dayofweek&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">],</span>
    <span class="n">num_threads</span><span class="o">=</span><span class="mi">2</span>
<span class="p">)</span>

<span class="n">ts</span> <span class="o">=</span> <span class="n">TimeSeries</span><span class="p">(</span><span class="o">**</span><span class="n">flow_config</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The series values are stored as a GroupedArray in an attribute <code>ga</code>. If the data type of the series values is an int then it is converted to <code>np.float32</code>, this is because lags generate <code>np.nan</code>s so we need a float data type for them.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_equal</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">ga</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">series</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The series ids are stored in an <code>uids</code> attribute.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">uids</span><span class="p">,</span> <span class="n">series</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For each time serie, the last observed date is stored so that predictions start from the last date + the frequency.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">last_dates</span><span class="p">,</span> <span class="n">series</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">)[</span><span class="s1">&#39;ds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The last row of every serie without the <code>y</code> and <code>ds</code> columns are taken as static features.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">ts</span><span class="o">.</span><span class="n">static_features</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you pass <code>static_features</code> to <a href="/mlforecast/core.html#TimeSeries.fit_transform"><code>TimeSeries.fit_transform</code></a> then only these are kept.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">static_features</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;static_0&#39;</span><span class="p">])</span>

<span class="k">assert</span> <span class="n">ts</span><span class="o">.</span><span class="n">static_features</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)[[</span><span class="s1">&#39;static_0&#39;</span><span class="p">]])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can also specify <code>keep_last_n</code> in <a href="/mlforecast/core.html#TimeSeries.fit_transform"><code>TimeSeries.fit_transform</code></a>, which means that after computing the features for training we want to keep only the last <code>n</code> samples of each time serie for computing the updates. This saves both memory and time, since the updates are performed by running the transformation functions on all time series again and keeping only the last value (the update).</p>
<p>If you have very long time series and your updates only require a small sample it's recommended that you set <code>keep_last_n</code> to the minimum number of samples required to compute the updates, which in this case is 15 since we have a rolling mean of size 14 over the lag 2 and in the first update the lag 2 becomes the lag 1. This is because in the first update the lag 1 is the last value of the series (or the lag 0), the lag 2 is the lag 1 and so on.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">keep_last_n</span> <span class="o">=</span> <span class="mi">15</span>

<span class="n">ts</span> <span class="o">=</span> <span class="n">TimeSeries</span><span class="p">(</span><span class="o">**</span><span class="n">flow_config</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">keep_last_n</span><span class="o">=</span><span class="n">keep_last_n</span><span class="p">)</span>

<span class="n">expected_lags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lag-7&#39;</span><span class="p">,</span> <span class="s1">&#39;lag-14&#39;</span><span class="p">]</span>
<span class="n">expected_transforms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;expanding_mean_lag-1&#39;</span><span class="p">,</span> 
                       <span class="s1">&#39;rolling_mean_lag-2_window_size-7&#39;</span><span class="p">,</span> 
                       <span class="s1">&#39;rolling_mean_lag-2_window_size-14&#39;</span><span class="p">]</span>
<span class="n">expected_date_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dayofweek&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">]</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">expected_lags</span> <span class="o">+</span> <span class="n">expected_transforms</span> <span class="o">+</span> <span class="n">expected_date_features</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">static_features</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="n">ts</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="c1"># we dropped 2 rows because of the lag 2 and 13 more to have the window of size 14</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">series</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">13</span><span class="p">)</span> <span class="o">*</span> <span class="n">ts</span><span class="o">.</span><span class="n">ga</span><span class="o">.</span><span class="n">ngroups</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">ga</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">ga</span><span class="o">.</span><span class="n">ngroups</span> <span class="o">*</span> <span class="n">keep_last_n</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you get the minimum number of samples that your transformation needs wrong i.e. you generate <code>np.nan</code>s in the update, you'll get a warning.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ts</span> <span class="o">=</span> <span class="n">TimeSeries</span><span class="p">(</span><span class="n">lag_transforms</span><span class="o">=</span><span class="p">{</span><span class="mi">2</span><span class="p">:</span> <span class="p">[(</span><span class="n">rolling_mean</span><span class="p">,</span> <span class="mi">14</span><span class="p">)]})</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">keep_last_n</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">test_warns</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">_update_features</span><span class="p">(),</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>&lt;class &#39;UserWarning&#39;&gt;: Found null values in rolling_mean_lag-2_window_size-14.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As a rule of thumb the minimum number of samples you need is max(lag + window_size) - 1 for rolling operations. <strong>If you have expanding features you need all samples to get the correct value</strong>, this won't raise a warning because there won't be null values, however the feature value will be wrong.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="/mlforecast/core.html#TimeSeries.fit_transform"><code>TimeSeries.fit_transform</code></a> requires that the <em>y</em> column doesn't have any null values. This is because the transformations could propagate them forward, so if you have null values in the <em>y</em> column you'll get an error.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">series_with_nulls</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">series_with_nulls</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">test_fail</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">series_with_nulls</span><span class="p">),</span> <span class="n">contains</span><span class="o">=</span><span class="s1">&#39;y column contains null values&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TimeSeries.predict" class="doc_header"><code>TimeSeries.predict</code><a href="https://github.com/Nixtla/mlforecast/tree/main/mlforecast/core.py#L379" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TimeSeries.predict</code>(<strong><code>model</code></strong>, <strong><code>horizon</code></strong>:<code>int</code>, <strong><code>predict_fn</code></strong>:<code>Callable</code>=<em><code>simple_predict</code></em>, <strong>**<code>predict_fn_kwargs</code></strong>)</p>
</blockquote>
<p>Use <code>model</code> to predict the next <code>horizon</code> timesteps.</p>
<p><code>predict_fn(model, new_x, features_order, **predict_fn_kwargs)</code> is called on each timestep.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Once we have a trained model we can use <a href="/mlforecast/core.html#TimeSeries.predict"><code>TimeSeries.predict</code></a> passing the model and the horizon to get the predictions back.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">DummyModel</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;lag-7&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="n">horizon</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">DummyModel</span><span class="p">()</span>
<span class="n">ts</span> <span class="o">=</span> <span class="n">TimeSeries</span><span class="p">(</span><span class="o">**</span><span class="n">flow_config</span><span class="p">)</span>
<span class="n">ts</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">horizon</span><span class="p">)</span>

<span class="n">grouped_series</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">)</span>
<span class="n">expected_preds</span> <span class="o">=</span> <span class="n">grouped_series</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>  <span class="c1"># the model predicts the lag-7</span>
<span class="n">last_dates</span> <span class="o">=</span> <span class="n">grouped_series</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">expected_dsmin</span> <span class="o">=</span> <span class="n">last_dates</span> <span class="o">+</span> <span class="n">ts</span><span class="o">.</span><span class="n">freq</span>
<span class="n">expected_dsmax</span> <span class="o">=</span> <span class="n">last_dates</span> <span class="o">+</span> <span class="n">horizon</span> <span class="o">*</span> <span class="n">ts</span><span class="o">.</span><span class="n">freq</span>
<span class="n">grouped_preds</span> <span class="o">=</span> <span class="n">predictions</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;y_pred&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">expected_preds</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">grouped_preds</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">expected_dsmin</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">grouped_preds</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">expected_dsmax</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

