<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Full pipeline encapsulation">

<title>mlforecast - MLForecast</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-NXJNCVR18L"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-NXJNCVR18L', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="mlforecast - MLForecast">
<meta property="og:description" content="Full pipeline encapsulation">
<meta property="og:image" content="https://github.com/Nixtla/styles/blob/2abf51612584169874c90cd7c4d347e3917eaf73/images/Banner%20Github.png">
<meta property="og:site-name" content="mlforecast">
<meta name="twitter:title" content="mlforecast - MLForecast">
<meta name="twitter:description" content="Full pipeline encapsulation">
<meta name="twitter:image" content="https://farm6.staticflickr.com/5510/14338202952_93595258ff_z.jpg">
<meta name="twitter:site" content="@Nixtlainc">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">mlforecast</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./docs/getting-started/quick_start_local.html" rel="" target="" aria-current="page">
 <span class="menu-text">Get Started</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-nixtlaverse" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">NixtlaVerse</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-nixtlaverse">    
        <li>
    <a class="dropdown-item" href="https://github.com/nixtla/statsforecast" rel="" target="">
 <span class="dropdown-text">StatsForecast ‚ö°Ô∏è</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/nixtla/neuralforecast" rel="" target="">
 <span class="dropdown-text">NeuralForecast üß†</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/nixtla/hierarchicalforecast" rel="" target="">
 <span class="dropdown-text">HierarchicalForecast üëë</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-help" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Help</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-help">    
        <li>
    <a class="dropdown-item" href="https://github.com/nixtla/mlforecast/issues/new/choose" rel="" target=""><i class="bi bi-bug" role="img">
</i> 
 <span class="dropdown-text">Report an Issue</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://join.slack.com/t/nixtlaworkspace/shared_invite/zt-135dssye9-fWTzMpv2WBthq8NK0Yvu6A" rel="" target=""><i class="bi bi-chat-right-text" role="img">
</i> 
 <span class="dropdown-text">Join our Slack</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/nixtla/mlforecast" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/nixtlainc" rel="" target=""><i class="bi bi-twitter" role="img" aria-label="Nixtla Twitter">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">API reference</li><li class="breadcrumb-item"><a href="./forecast.html">Local</a></li><li class="breadcrumb-item"><a href="./forecast.html">MLForecast</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">mlforecast</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">
 <span class="menu-text">Getting started</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/getting-started/install.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Install</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/getting-started/quick_start_local.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quick start (local)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/getting-started/quick_start_distributed.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quick start (distributed)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/getting-started/end_to_end_walkthrough.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">End to end walkthrough</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">How-to guides</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/exogenous_features.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exogenous features</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/lag_transforms_guide.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lag transformations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/transforming_exog.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transforming exogenous features</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/cross_validation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Cross validation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/prediction_intervals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Probabilistic forecasting</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/target_transforms_guide.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Target transformations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/analyzing_models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analyzing the trained models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/custom_training.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Custom training</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/training_with_numpy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Training with numpy arrays</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/one_model_per_horizon.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">One model per step</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/custom_date_features.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Custom date features</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/predict_callbacks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Predict callbacks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/predict_subset.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Predicting a subset of ids</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/transfer_learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transfer Learning</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/tutorials/electricity_load_forecasting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Electricity Load Forecast</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/tutorials/electricity_peak_forecasting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Detect Demand Peaks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/tutorials/prediction_intervals_in_forecasting_models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prediction intervals</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">API reference</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Local</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./forecast.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">MLForecast</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lgb_cv.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">LightGBMCV</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Utils</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./core.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Core</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./target_transforms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Target transforms</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lag_transforms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lag transforms</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./feature_engineering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Feature engineering</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./callbacks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Callbacks</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false">
 <span class="menu-text">Distributed</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./distributed.forecast.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Distributed Forecast</span></a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false">
 <span class="menu-text">Models</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./distributed.models.dask.lgb.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DaskLGBMForecast</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./distributed.models.dask.xgb.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DaskXGBForecast</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./distributed.models.ray.lgb.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">RayLGBMForecast</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./distributed.models.ray.xgb.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">RayXGBForecast</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./distributed.models.spark.lgb.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SparkLGBMForecast</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./distributed.models.spark.xgb.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SparkXGBForecast</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#data" id="toc-data" class="nav-link active" data-scroll-target="#data">Data</a></li>
  <li><a href="#mlforecast" id="toc-mlforecast" class="nav-link" data-scroll-target="#mlforecast">MLForecast</a></li>
  <li><a href="#mlforecast.fit" id="toc-mlforecast.fit" class="nav-link" data-scroll-target="#mlforecast.fit">MLForecast.fit</a></li>
  <li><a href="#mlforecast.forecast_fitted_values" id="toc-mlforecast.forecast_fitted_values" class="nav-link" data-scroll-target="#mlforecast.forecast_fitted_values">MLForecast.forecast_fitted_values</a></li>
  <li><a href="#mlforecast.predict" id="toc-mlforecast.predict" class="nav-link" data-scroll-target="#mlforecast.predict">MLForecast.predict</a></li>
  <li><a href="#mlforecast.preprocess" id="toc-mlforecast.preprocess" class="nav-link" data-scroll-target="#mlforecast.preprocess">MLForecast.preprocess</a></li>
  <li><a href="#mlforecast.fit_models" id="toc-mlforecast.fit_models" class="nav-link" data-scroll-target="#mlforecast.fit_models">MLForecast.fit_models</a></li>
  <li><a href="#mlforecast.cross_validation" id="toc-mlforecast.cross_validation" class="nav-link" data-scroll-target="#mlforecast.cross_validation">MLForecast.cross_validation</a></li>
  <li><a href="#mlforecast.from_cv" id="toc-mlforecast.from_cv" class="nav-link" data-scroll-target="#mlforecast.from_cv">MLForecast.from_cv</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/Nixtla/mlforecast/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">MLForecast</h1>
</div>

<div>
  <div class="description">
    Full pipeline encapsulation
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="data" class="level3">
<h3 class="anchored" data-anchor-id="data">Data</h3>
<p>This shows an example with just 4 series of the M4 dataset. If you want to run it yourself on all of them, you can refer to <a href="https://www.kaggle.com/code/lemuz90/m4-competition">this notebook</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lightgbm <span class="im">as</span> lgb</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xgboost <span class="im">as</span> xgb</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datasetsforecast.m4 <span class="im">import</span> M4, M4Info</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utilsforecast.plotting <span class="im">import</span> plot_series</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> window_ops.ewm <span class="im">import</span> ewm_mean</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> window_ops.expanding <span class="im">import</span> expanding_mean</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> window_ops.rolling <span class="im">import</span> rolling_mean</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mlforecast.lgb_cv <span class="im">import</span> LightGBMCV</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mlforecast.target_transforms <span class="im">import</span> Differences, LocalStandardScaler</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mlforecast.utils <span class="im">import</span> generate_daily_series</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>group <span class="op">=</span> <span class="st">'Hourly'</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> M4.async_download(<span class="st">'data'</span>, group<span class="op">=</span>group)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>df, <span class="op">*</span>_ <span class="op">=</span> M4.load(directory<span class="op">=</span><span class="st">'data'</span>, group<span class="op">=</span>group)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'ds'</span>] <span class="op">=</span> df[<span class="st">'ds'</span>].astype(<span class="st">'int'</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>ids <span class="op">=</span> df[<span class="st">'unique_id'</span>].unique()</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">0</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>sample_ids <span class="op">=</span> random.choices(ids, k<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>sample_df <span class="op">=</span> df[df[<span class="st">'unique_id'</span>].isin(sample_ids)]</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>sample_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">unique_id</th>
<th data-quarto-table-cell-role="th">ds</th>
<th data-quarto-table-cell-role="th">y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">86796</td>
<td>H196</td>
<td>1</td>
<td>11.8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">86797</td>
<td>H196</td>
<td>2</td>
<td>11.4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">86798</td>
<td>H196</td>
<td>3</td>
<td>11.1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">86799</td>
<td>H196</td>
<td>4</td>
<td>10.8</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">86800</td>
<td>H196</td>
<td>5</td>
<td>10.6</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">325235</td>
<td>H413</td>
<td>1004</td>
<td>99.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">325236</td>
<td>H413</td>
<td>1005</td>
<td>88.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">325237</td>
<td>H413</td>
<td>1006</td>
<td>47.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">325238</td>
<td>H413</td>
<td>1007</td>
<td>41.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">325239</td>
<td>H413</td>
<td>1008</td>
<td>34.0</td>
</tr>
</tbody>
</table>

<p>4032 rows √ó 3 columns</p>
</div>
</div>
</div>
<p>We now split this data into train and validation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>info <span class="op">=</span> M4Info[group]</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>horizon <span class="op">=</span> info.horizon</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> sample_df.groupby(<span class="st">'unique_id'</span>).tail(horizon)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> sample_df.drop(valid.index)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>train.shape, valid.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>((3840, 3), (192, 3))</code></pre>
</div>
</div>
<hr>
</section>
<section id="mlforecast" class="level3">
<h3 class="anchored" data-anchor-id="mlforecast">MLForecast</h3>
<blockquote class="blockquote">
<pre><code> MLForecast (models:Union[sklearn.base.BaseEstimator,List[sklearn.base.Bas
             eEstimator],Dict[str,sklearn.base.BaseEstimator]],
             freq:Union[int,str,pandas._libs.tslibs.offsets.BaseOffset],
             lags:Optional[Iterable[int]]=None, lag_transforms:Optional[Di
             ct[int,List[Union[Callable,Tuple[Callable,Any]]]]]=None,
             date_features:Optional[Iterable[Union[str,Callable]]]=None,
             num_threads:int=1, target_transforms:Optional[List[Union[mlfo
             recast.target_transforms.BaseTargetTransform,mlforecast.targe
             t_transforms.BaseGroupedArrayTargetTransform]]]=None)</code></pre>
</blockquote>
<p>Forecasting pipeline</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>models</td>
<td>typing.Union[sklearn.base.BaseEstimator, typing.List[sklearn.base.BaseEstimator], typing.Dict[str, sklearn.base.BaseEstimator]]</td>
<td></td>
<td>Models that will be trained and used to compute the forecasts.</td>
</tr>
<tr class="even">
<td>freq</td>
<td>typing.Union[int, str, pandas._libs.tslibs.offsets.BaseOffset]</td>
<td></td>
<td>Pandas offset, pandas offset alias, e.g.&nbsp;‚ÄòD‚Äô, ‚ÄòW-THU‚Äô or integer denoting the frequency of the series.</td>
</tr>
<tr class="odd">
<td>lags</td>
<td>typing.Optional[typing.Iterable[int]]</td>
<td>None</td>
<td>Lags of the target to use as features.</td>
</tr>
<tr class="even">
<td>lag_transforms</td>
<td>typing.Optional[typing.Dict[int, typing.List[typing.Union[typing.Callable, typing.Tuple[typing.Callable, typing.Any]]]]]</td>
<td>None</td>
<td>Mapping of target lags to their transformations.</td>
</tr>
<tr class="odd">
<td>date_features</td>
<td>typing.Optional[typing.Iterable[typing.Union[str, typing.Callable]]]</td>
<td>None</td>
<td>Features computed from the dates. Can be pandas date attributes or functions that will take the dates as input.</td>
</tr>
<tr class="even">
<td>num_threads</td>
<td>int</td>
<td>1</td>
<td>Number of threads to use when computing the features.</td>
</tr>
<tr class="odd">
<td>target_transforms</td>
<td>typing.Optional[typing.List[typing.Union[mlforecast.target_transforms.BaseTargetTransform, mlforecast.target_transforms.BaseGroupedArrayTargetTransform]]]</td>
<td>None</td>
<td>Transformations that will be applied to the target before computing the features and restored after the forecasting step.</td>
</tr>
</tbody>
</table>
<p>The MLForecast object encapsulates the feature engineering + training the models + forecasting</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>fcst <span class="op">=</span> MLForecast(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    models<span class="op">=</span>lgb.LGBMRegressor(random_state<span class="op">=</span><span class="dv">0</span>, verbosity<span class="op">=-</span><span class="dv">1</span>),</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    freq<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    lags<span class="op">=</span>[<span class="dv">24</span> <span class="op">*</span> (i<span class="op">+</span><span class="dv">1</span>) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">7</span>)],</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    lag_transforms<span class="op">=</span>{</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="dv">48</span>: [(ewm_mean, <span class="fl">0.3</span>)],</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    num_threads<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    target_transforms<span class="op">=</span>[Differences([<span class="dv">24</span>])],</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>fcst</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>MLForecast(models=[LGBMRegressor], freq=1, lag_features=['lag24', 'lag48', 'lag72', 'lag96', 'lag120', 'lag144', 'lag168', 'ewm_mean_lag48_alpha0.3'], date_features=[], num_threads=1)</code></pre>
</div>
</div>
<p>Once we have this setup we can compute the features and fit the model.</p>
<hr>
</section>
<section id="mlforecast.fit" class="level3">
<h3 class="anchored" data-anchor-id="mlforecast.fit">MLForecast.fit</h3>
<blockquote class="blockquote">
<pre><code> MLForecast.fit
                 (df:Union[pandas.core.frame.DataFrame,polars.dataframe.fr
                 ame.DataFrame], id_col:str='unique_id',
                 time_col:str='ds', target_col:str='y',
                 static_features:Optional[List[str]]=None,
                 dropna:bool=True, keep_last_n:Optional[int]=None,
                 max_horizon:Optional[int]=None, prediction_intervals:Opti
                 onal[mlforecast.utils.PredictionIntervals]=None,
                 fitted:bool=False, as_numpy:bool=False)</code></pre>
</blockquote>
<p>Apply the feature engineering and train the models.</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>df</td>
<td>typing.Union[pandas.core.frame.DataFrame, polars.dataframe.frame.DataFrame]</td>
<td></td>
<td>Series data in long format.</td>
</tr>
<tr class="even">
<td>id_col</td>
<td>str</td>
<td>unique_id</td>
<td>Column that identifies each serie.</td>
</tr>
<tr class="odd">
<td>time_col</td>
<td>str</td>
<td>ds</td>
<td>Column that identifies each timestep, its values can be timestamps or integers.</td>
</tr>
<tr class="even">
<td>target_col</td>
<td>str</td>
<td>y</td>
<td>Column that contains the target.</td>
</tr>
<tr class="odd">
<td>static_features</td>
<td>typing.Optional[typing.List[str]]</td>
<td>None</td>
<td>Names of the features that are static and will be repeated when forecasting.<br> If <code>None</code>, will consider all columns (except id_col and time_col) as static.</td>
</tr>
<tr class="even">
<td>dropna</td>
<td>bool</td>
<td>True</td>
<td>Drop rows with missing values produced by the transformations.</td>
</tr>
<tr class="odd">
<td>keep_last_n</td>
<td>typing.Optional[int]</td>
<td>None</td>
<td>Keep only these many records from each serie for the forecasting step. Can save time and memory if your features allow it.</td>
</tr>
<tr class="even">
<td>max_horizon</td>
<td>typing.Optional[int]</td>
<td>None</td>
<td>Train this many models, where each model will predict a specific horizon.</td>
</tr>
<tr class="odd">
<td>prediction_intervals</td>
<td>typing.Optional[mlforecast.utils.PredictionIntervals]</td>
<td>None</td>
<td>Configuration to calibrate prediction intervals (Conformal Prediction).</td>
</tr>
<tr class="even">
<td>fitted</td>
<td>bool</td>
<td>False</td>
<td>Save in-sample predictions.</td>
</tr>
<tr class="odd">
<td>as_numpy</td>
<td>bool</td>
<td>False</td>
<td>Cast features to numpy array.</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>MLForecast</strong></td>
<td></td>
<td><strong>Forecast object with series values and trained models.</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>fcst <span class="op">=</span> MLForecast(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    models<span class="op">=</span>lgb.LGBMRegressor(random_state<span class="op">=</span><span class="dv">0</span>, verbosity<span class="op">=-</span><span class="dv">1</span>),</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    freq<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    lags<span class="op">=</span>[<span class="dv">24</span> <span class="op">*</span> (i<span class="op">+</span><span class="dv">1</span>) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">7</span>)],</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    lag_transforms<span class="op">=</span>{</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        <span class="dv">48</span>: [(ewm_mean, <span class="fl">0.3</span>)],</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    num_threads<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    target_transforms<span class="op">=</span>[Differences([<span class="dv">24</span>])],</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>fcst.fit(train, fitted<span class="op">=</span><span class="va">True</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="mlforecast.forecast_fitted_values" class="level3">
<h3 class="anchored" data-anchor-id="mlforecast.forecast_fitted_values">MLForecast.forecast_fitted_values</h3>
<blockquote class="blockquote">
<pre><code> MLForecast.forecast_fitted_values ()</code></pre>
</blockquote>
<p>Access in-sample predictions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>fcst.forecast_fitted_values()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">unique_id</th>
<th data-quarto-table-cell-role="th">ds</th>
<th data-quarto-table-cell-role="th">y</th>
<th data-quarto-table-cell-role="th">LGBMRegressor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>H196</td>
<td>193</td>
<td>12.7</td>
<td>12.671271</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>H196</td>
<td>194</td>
<td>12.3</td>
<td>12.271271</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>H196</td>
<td>195</td>
<td>11.9</td>
<td>11.871271</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>H196</td>
<td>196</td>
<td>11.7</td>
<td>11.671271</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>H196</td>
<td>197</td>
<td>11.4</td>
<td>11.471271</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3067</td>
<td>H413</td>
<td>956</td>
<td>59.0</td>
<td>68.280574</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3068</td>
<td>H413</td>
<td>957</td>
<td>58.0</td>
<td>70.427570</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3069</td>
<td>H413</td>
<td>958</td>
<td>53.0</td>
<td>44.767965</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3070</td>
<td>H413</td>
<td>959</td>
<td>38.0</td>
<td>48.691257</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3071</td>
<td>H413</td>
<td>960</td>
<td>46.0</td>
<td>46.652238</td>
</tr>
</tbody>
</table>

<p>3072 rows √ó 4 columns</p>
</div>
</div>
</div>
<p>Once we‚Äôve run this we‚Äôre ready to compute our predictions.</p>
<hr>
</section>
<section id="mlforecast.predict" class="level3">
<h3 class="anchored" data-anchor-id="mlforecast.predict">MLForecast.predict</h3>
<blockquote class="blockquote">
<pre><code> MLForecast.predict (h:int,
                     before_predict_callback:Optional[Callable]=None,
                     after_predict_callback:Optional[Callable]=None, new_d
                     f:Union[pandas.core.frame.DataFrame,polars.dataframe.
                     frame.DataFrame,NoneType]=None,
                     level:Optional[List[Union[int,float]]]=None, X_df:Uni
                     on[pandas.core.frame.DataFrame,polars.dataframe.frame
                     .DataFrame,NoneType]=None,
                     ids:Optional[List[str]]=None)</code></pre>
</blockquote>
<p>Compute the predictions for the next <code>h</code> steps.</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>h</td>
<td>int</td>
<td></td>
<td>Number of periods to predict.</td>
</tr>
<tr class="even">
<td>before_predict_callback</td>
<td>typing.Optional[typing.Callable]</td>
<td>None</td>
<td>Function to call on the features before computing the predictions.<br> This function will take the input dataframe that will be passed to the model for predicting and should return a dataframe with the same structure.<br> The series identifier is on the index.</td>
</tr>
<tr class="odd">
<td>after_predict_callback</td>
<td>typing.Optional[typing.Callable]</td>
<td>None</td>
<td>Function to call on the predictions before updating the targets.<br> This function will take a pandas Series with the predictions and should return another one with the same structure.<br> The series identifier is on the index.</td>
</tr>
<tr class="even">
<td>new_df</td>
<td>typing.Union[pandas.core.frame.DataFrame, polars.dataframe.frame.DataFrame, NoneType]</td>
<td>None</td>
<td>Series data of new observations for which forecasts are to be generated. <br> This dataframe should have the same structure as the one used to fit the model, including any features and time series data. <br> If <code>new_df</code> is not None, the method will generate forecasts for the new observations.</td>
</tr>
<tr class="odd">
<td>level</td>
<td>typing.Optional[typing.List[typing.Union[int, float]]]</td>
<td>None</td>
<td>Confidence levels between 0 and 100 for prediction intervals.</td>
</tr>
<tr class="even">
<td>X_df</td>
<td>typing.Union[pandas.core.frame.DataFrame, polars.dataframe.frame.DataFrame, NoneType]</td>
<td>None</td>
<td>Dataframe with the future exogenous features. Should have the id column and the time column.</td>
</tr>
<tr class="odd">
<td>ids</td>
<td>typing.Optional[typing.List[str]]</td>
<td>None</td>
<td>List with subset of ids seen during training for which the forecasts should be computed.</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>typing.Union[pandas.core.frame.DataFrame, polars.dataframe.frame.DataFrame]</strong></td>
<td></td>
<td><strong>Predictions for each serie and timestep, with one column per model.</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> fcst.predict(horizon)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see at a couple of results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> valid.merge(predictions, on<span class="op">=</span>[<span class="st">'unique_id'</span>, <span class="st">'ds'</span>])</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plot_series(train, results, max_insample_length<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>fig.savefig(<span class="st">'figs/forecast__predict.png'</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="figs/forecast__predict.png" class="img-fluid"></p>
<section id="prediction-intervals" class="level4">
<h4 class="anchored" data-anchor-id="prediction-intervals">Prediction intervals</h4>
<p>With <code>MLForecast</code>, you can generate prediction intervals using Conformal Prediction. To configure Conformal Prediction, you need to pass an instance of the <code>PredictionIntervals</code> class to the <code>prediction_intervals</code> argument of the <code>fit</code> method. The class takes three parameters: <code>n_windows</code>, <code>h</code> and <code>method</code>.</p>
<ul>
<li><code>n_windows</code> represents the number of cross-validation windows used to calibrate the intervals</li>
<li><code>h</code> is the forecast horizon</li>
<li><code>method</code> can be <code>conformal_distribution</code> or <code>conformal_error</code>; <code>conformal_distribution</code> (default) creates forecasts paths based on the cross-validation errors and calculate quantiles using those paths, on the other hand <code>conformal_error</code> calculates the error quantiles to produce prediction intervals. The strategy will adjust the intervals for each horizon step, resulting in different widths for each step. Please note that a minimum of 2 cross-validation windows must be used.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>fcst.fit(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    train,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    prediction_intervals<span class="op">=</span>PredictionIntervals(n_windows<span class="op">=</span><span class="dv">3</span>, h<span class="op">=</span><span class="dv">48</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After that, you just have to include your desired confidence levels to the <code>predict</code> method using the <code>level</code> argument. Levels must lie between 0 and 100.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>predictions_w_intervals <span class="op">=</span> fcst.predict(<span class="dv">48</span>, level<span class="op">=</span>[<span class="dv">50</span>, <span class="dv">80</span>, <span class="dv">95</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>predictions_w_intervals.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">unique_id</th>
<th data-quarto-table-cell-role="th">ds</th>
<th data-quarto-table-cell-role="th">LGBMRegressor</th>
<th data-quarto-table-cell-role="th">LGBMRegressor-lo-95</th>
<th data-quarto-table-cell-role="th">LGBMRegressor-lo-80</th>
<th data-quarto-table-cell-role="th">LGBMRegressor-lo-50</th>
<th data-quarto-table-cell-role="th">LGBMRegressor-hi-50</th>
<th data-quarto-table-cell-role="th">LGBMRegressor-hi-80</th>
<th data-quarto-table-cell-role="th">LGBMRegressor-hi-95</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>H196</td>
<td>961</td>
<td>16.071271</td>
<td>15.958042</td>
<td>15.971271</td>
<td>16.005091</td>
<td>16.137452</td>
<td>16.171271</td>
<td>16.184501</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>H196</td>
<td>962</td>
<td>15.671271</td>
<td>15.553632</td>
<td>15.553632</td>
<td>15.578632</td>
<td>15.763911</td>
<td>15.788911</td>
<td>15.788911</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>H196</td>
<td>963</td>
<td>15.271271</td>
<td>15.153632</td>
<td>15.153632</td>
<td>15.162452</td>
<td>15.380091</td>
<td>15.388911</td>
<td>15.388911</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>H196</td>
<td>964</td>
<td>14.971271</td>
<td>14.858042</td>
<td>14.871271</td>
<td>14.905091</td>
<td>15.037452</td>
<td>15.071271</td>
<td>15.084501</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>H196</td>
<td>965</td>
<td>14.671271</td>
<td>14.553632</td>
<td>14.553632</td>
<td>14.562452</td>
<td>14.780091</td>
<td>14.788911</td>
<td>14.788911</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># test we can forecast horizon lower than h </span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># with prediction intervals</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> method <span class="kw">in</span> [<span class="st">'conformal_distribution'</span>, <span class="st">'conformal_errors'</span>]:</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    fcst.fit(</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>        train, </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>        prediction_intervals<span class="op">=</span>PredictionIntervals(n_windows<span class="op">=</span><span class="dv">3</span>, h<span class="op">=</span><span class="dv">48</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    preds_h_lower_h <span class="op">=</span> fcst.predict(<span class="dv">1</span>, level<span class="op">=</span>[<span class="dv">50</span>, <span class="dv">80</span>, <span class="dv">95</span>])</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    preds_h_lower_h <span class="op">=</span> fcst.predict(<span class="dv">30</span>, level<span class="op">=</span>[<span class="dv">50</span>, <span class="dv">80</span>, <span class="dv">95</span>])</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># test monotonicity of intervals</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    test_eq(</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>        preds_h_lower_h.<span class="bu">filter</span>(regex<span class="op">=</span><span class="st">'lo|hi'</span>).<span class="bu">apply</span>(</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: x.is_monotonic_increasing,</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>            axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>        ).<span class="bu">sum</span>(),</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">len</span>(preds_h_lower_h)</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let‚Äôs explore the generated intervals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> valid.merge(predictions_w_intervals, on<span class="op">=</span>[<span class="st">'unique_id'</span>, <span class="st">'ds'</span>])</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plot_series(train, results, max_insample_length<span class="op">=</span><span class="dv">0</span>, level<span class="op">=</span>[<span class="dv">50</span>, <span class="dv">80</span>, <span class="dv">95</span>])</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>fig.savefig(<span class="st">'figs/forecast__predict_intervals.png'</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="figs/forecast__predict_intervals.png" class="img-fluid"></p>
<p>If you want to reduce the computational time and produce intervals with the same width for the whole forecast horizon, simple pass <code>h=1</code> to the <code>PredictionIntervals</code> class. The caveat of this strategy is that in some cases, variance of the absolute residuals maybe be small (even zero), so the intervals may be too narrow.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>fcst.fit(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    train,  </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    prediction_intervals<span class="op">=</span>PredictionIntervals(n_windows<span class="op">=</span><span class="dv">3</span>, h<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>predictions_w_intervals_ws_1 <span class="op">=</span> fcst.predict(<span class="dv">48</span>, level<span class="op">=</span>[<span class="dv">80</span>, <span class="dv">90</span>, <span class="dv">95</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let‚Äôs explore the generated intervals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> valid.merge(predictions_w_intervals_ws_1, on<span class="op">=</span>[<span class="st">'unique_id'</span>, <span class="st">'ds'</span>])</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plot_series(train, results, max_insample_length<span class="op">=</span><span class="dv">0</span>, level<span class="op">=</span>[<span class="dv">90</span>])</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>fig.savefig(<span class="st">'figs/forecast__predict_intervals_window_size_1.png'</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="figs/forecast__predict_intervals_window_size_1.png" class="img-fluid"></p>
</section>
<section id="forecast-using-a-pretrained-model" class="level4">
<h4 class="anchored" data-anchor-id="forecast-using-a-pretrained-model">Forecast using a pretrained model</h4>
<p>MLForecast allows you to use a pretrained model to generate forecasts for a new dataset. Simply provide a pandas dataframe containing the new observations as the value for the <code>new_df</code> argument when calling the <code>predict</code> method. The dataframe should have the same structure as the one used to fit the model, including any features and time series data. The function will then use the pretrained model to generate forecasts for the new observations. This allows you to easily apply a pretrained model to a new dataset and generate forecasts without the need to retrain the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>ercot_df <span class="op">=</span> pd.read_csv(<span class="st">'https://datasets-nixtla.s3.amazonaws.com/ERCOT-clean.csv'</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we have to convert the ds column to integers</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># since MLForecast was trained with that structure</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>ercot_df[<span class="st">'ds'</span>] <span class="op">=</span> np.arange(<span class="dv">1</span>, <span class="bu">len</span>(ercot_df) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co"># use the `new_df` argument to pass the ercot dataset </span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>ercot_fcsts <span class="op">=</span> fcst.predict(horizon, new_df<span class="op">=</span>ercot_df)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plot_series(ercot_df, ercot_fcsts, max_insample_length<span class="op">=</span><span class="dv">48</span> <span class="op">*</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="figs/forecast__ercot.png" class="img-fluid"></p>
<p>If you want to take a look at the data that will be used to train the models you can call <code>Forecast.preprocess</code>.</p>
<hr>
</section>
</section>
<section id="mlforecast.preprocess" class="level3">
<h3 class="anchored" data-anchor-id="mlforecast.preprocess">MLForecast.preprocess</h3>
<blockquote class="blockquote">
<pre><code> MLForecast.preprocess
                        (df:Union[pandas.core.frame.DataFrame,polars.dataf
                        rame.frame.DataFrame], id_col:str='unique_id',
                        time_col:str='ds', target_col:str='y',
                        static_features:Optional[List[str]]=None,
                        dropna:bool=True, keep_last_n:Optional[int]=None,
                        max_horizon:Optional[int]=None,
                        return_X_y:bool=False, as_numpy:bool=False)</code></pre>
</blockquote>
<p>Add the features to <code>data</code>.</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>df</td>
<td>typing.Union[pandas.core.frame.DataFrame, polars.dataframe.frame.DataFrame]</td>
<td></td>
<td>Series data in long format.</td>
</tr>
<tr class="even">
<td>id_col</td>
<td>str</td>
<td>unique_id</td>
<td>Column that identifies each serie.</td>
</tr>
<tr class="odd">
<td>time_col</td>
<td>str</td>
<td>ds</td>
<td>Column that identifies each timestep, its values can be timestamps or integers.</td>
</tr>
<tr class="even">
<td>target_col</td>
<td>str</td>
<td>y</td>
<td>Column that contains the target.</td>
</tr>
<tr class="odd">
<td>static_features</td>
<td>typing.Optional[typing.List[str]]</td>
<td>None</td>
<td>Names of the features that are static and will be repeated when forecasting.</td>
</tr>
<tr class="even">
<td>dropna</td>
<td>bool</td>
<td>True</td>
<td>Drop rows with missing values produced by the transformations.</td>
</tr>
<tr class="odd">
<td>keep_last_n</td>
<td>typing.Optional[int]</td>
<td>None</td>
<td>Keep only these many records from each serie for the forecasting step. Can save time and memory if your features allow it.</td>
</tr>
<tr class="even">
<td>max_horizon</td>
<td>typing.Optional[int]</td>
<td>None</td>
<td>Train this many models, where each model will predict a specific horizon.</td>
</tr>
<tr class="odd">
<td>return_X_y</td>
<td>bool</td>
<td>False</td>
<td>Return a tuple with the features and the target. If False will return a single dataframe.</td>
</tr>
<tr class="even">
<td>as_numpy</td>
<td>bool</td>
<td>False</td>
<td>Cast features to numpy array. Only works for <code>return_X_y=True</code>.</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>typing.Union[pandas.core.frame.DataFrame, polars.dataframe.frame.DataFrame, typing.Tuple[typing.Union[pandas.core.frame.DataFrame, polars.dataframe.frame.DataFrame], numpy.ndarray]]</strong></td>
<td></td>
<td><strong><code>df</code> plus added features and target(s).</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>prep_df <span class="op">=</span> fcst.preprocess(train)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>prep_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">unique_id</th>
<th data-quarto-table-cell-role="th">ds</th>
<th data-quarto-table-cell-role="th">y</th>
<th data-quarto-table-cell-role="th">lag24</th>
<th data-quarto-table-cell-role="th">lag48</th>
<th data-quarto-table-cell-role="th">lag72</th>
<th data-quarto-table-cell-role="th">lag96</th>
<th data-quarto-table-cell-role="th">lag120</th>
<th data-quarto-table-cell-role="th">lag144</th>
<th data-quarto-table-cell-role="th">lag168</th>
<th data-quarto-table-cell-role="th">ewm_mean_lag48_alpha0.3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">86988</td>
<td>H196</td>
<td>193</td>
<td>0.1</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.3</td>
<td>0.1</td>
<td>0.1</td>
<td>0.3</td>
<td>0.002810</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">86989</td>
<td>H196</td>
<td>194</td>
<td>0.1</td>
<td>-0.1</td>
<td>0.1</td>
<td>0.0</td>
<td>0.3</td>
<td>0.1</td>
<td>0.1</td>
<td>0.3</td>
<td>0.031967</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">86990</td>
<td>H196</td>
<td>195</td>
<td>0.1</td>
<td>-0.1</td>
<td>0.1</td>
<td>0.0</td>
<td>0.3</td>
<td>0.1</td>
<td>0.2</td>
<td>0.1</td>
<td>0.052377</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">86991</td>
<td>H196</td>
<td>196</td>
<td>0.1</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.3</td>
<td>0.2</td>
<td>0.1</td>
<td>0.2</td>
<td>0.036664</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">86992</td>
<td>H196</td>
<td>197</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.1</td>
<td>0.2</td>
<td>0.2</td>
<td>0.1</td>
<td>0.2</td>
<td>0.025665</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">325187</td>
<td>H413</td>
<td>956</td>
<td>0.0</td>
<td>10.0</td>
<td>1.0</td>
<td>6.0</td>
<td>-53.0</td>
<td>44.0</td>
<td>-21.0</td>
<td>21.0</td>
<td>7.963225</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">325188</td>
<td>H413</td>
<td>957</td>
<td>9.0</td>
<td>10.0</td>
<td>10.0</td>
<td>-7.0</td>
<td>-46.0</td>
<td>27.0</td>
<td>-19.0</td>
<td>24.0</td>
<td>8.574257</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">325189</td>
<td>H413</td>
<td>958</td>
<td>16.0</td>
<td>8.0</td>
<td>5.0</td>
<td>-9.0</td>
<td>-36.0</td>
<td>32.0</td>
<td>-13.0</td>
<td>8.0</td>
<td>7.501980</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">325190</td>
<td>H413</td>
<td>959</td>
<td>-3.0</td>
<td>17.0</td>
<td>-7.0</td>
<td>2.0</td>
<td>-31.0</td>
<td>22.0</td>
<td>5.0</td>
<td>-2.0</td>
<td>3.151386</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">325191</td>
<td>H413</td>
<td>960</td>
<td>15.0</td>
<td>11.0</td>
<td>-6.0</td>
<td>-5.0</td>
<td>-17.0</td>
<td>22.0</td>
<td>-18.0</td>
<td>10.0</td>
<td>0.405970</td>
</tr>
</tbody>
</table>

<p>3072 rows √ó 11 columns</p>
</div>
</div>
</div>
<p>If we do this we then have to call <code>Forecast.fit_models</code>, since this only stores the series information.</p>
<hr>
</section>
<section id="mlforecast.fit_models" class="level3">
<h3 class="anchored" data-anchor-id="mlforecast.fit_models">MLForecast.fit_models</h3>
<blockquote class="blockquote">
<pre><code> MLForecast.fit_models (X:Union[pandas.core.frame.DataFrame,polars.datafra
                        me.frame.DataFrame,numpy.ndarray],
                        y:numpy.ndarray)</code></pre>
</blockquote>
<p>Manually train models. Use this if you called <code>MLForecast.preprocess</code> beforehand.</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>X</td>
<td>typing.Union[pandas.core.frame.DataFrame, polars.dataframe.frame.DataFrame, numpy.ndarray]</td>
<td>Features.</td>
</tr>
<tr class="even">
<td>y</td>
<td>ndarray</td>
<td>Target.</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>MLForecast</strong></td>
<td><strong>Forecast object with trained models.</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>X, y <span class="op">=</span> prep_df.drop(columns<span class="op">=</span>[<span class="st">'unique_id'</span>, <span class="st">'ds'</span>, <span class="st">'y'</span>]), prep_df[<span class="st">'y'</span>]</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>fcst.fit_models(X, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>MLForecast(models=[LGBMRegressor], freq=1, lag_features=['lag24', 'lag48', 'lag72', 'lag96', 'lag120', 'lag144', 'lag168', 'ewm_mean_lag48_alpha0.3'], date_features=[], num_threads=1)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>predictions2 <span class="op">=</span> fcst.predict(horizon)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>pd.testing.assert_frame_equal(predictions, predictions2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="mlforecast.cross_validation" class="level3">
<h3 class="anchored" data-anchor-id="mlforecast.cross_validation">MLForecast.cross_validation</h3>
<blockquote class="blockquote">
<pre><code> MLForecast.cross_validation
                              (df:Union[pandas.core.frame.DataFrame,polars
                              .dataframe.frame.DataFrame], n_windows:int,
                              h:int, id_col:str='unique_id',
                              time_col:str='ds', target_col:str='y',
                              step_size:Optional[int]=None,
                              static_features:Optional[List[str]]=None,
                              dropna:bool=True,
                              keep_last_n:Optional[int]=None,
                              refit:Union[bool,int]=True,
                              max_horizon:Optional[int]=None, before_predi
                              ct_callback:Optional[Callable]=None, after_p
                              redict_callback:Optional[Callable]=None, pre
                              diction_intervals:Optional[mlforecast.utils.
                              PredictionIntervals]=None,
                              level:Optional[List[Union[int,float]]]=None,
                              input_size:Optional[int]=None,
                              fitted:bool=False, as_numpy:bool=False)</code></pre>
</blockquote>
<p>Perform time series cross validation. Creates <code>n_windows</code> splits where each window has <code>h</code> test periods, trains the models, computes the predictions and merges the actuals.</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>df</td>
<td>typing.Union[pandas.core.frame.DataFrame, polars.dataframe.frame.DataFrame]</td>
<td></td>
<td>Series data in long format.</td>
</tr>
<tr class="even">
<td>n_windows</td>
<td>int</td>
<td></td>
<td>Number of windows to evaluate.</td>
</tr>
<tr class="odd">
<td>h</td>
<td>int</td>
<td></td>
<td>Forecast horizon.</td>
</tr>
<tr class="even">
<td>id_col</td>
<td>str</td>
<td>unique_id</td>
<td>Column that identifies each serie.</td>
</tr>
<tr class="odd">
<td>time_col</td>
<td>str</td>
<td>ds</td>
<td>Column that identifies each timestep, its values can be timestamps or integers.</td>
</tr>
<tr class="even">
<td>target_col</td>
<td>str</td>
<td>y</td>
<td>Column that contains the target.</td>
</tr>
<tr class="odd">
<td>step_size</td>
<td>typing.Optional[int]</td>
<td>None</td>
<td>Step size between each cross validation window. If None it will be equal to <code>h</code>.</td>
</tr>
<tr class="even">
<td>static_features</td>
<td>typing.Optional[typing.List[str]]</td>
<td>None</td>
<td>Names of the features that are static and will be repeated when forecasting.</td>
</tr>
<tr class="odd">
<td>dropna</td>
<td>bool</td>
<td>True</td>
<td>Drop rows with missing values produced by the transformations.</td>
</tr>
<tr class="even">
<td>keep_last_n</td>
<td>typing.Optional[int]</td>
<td>None</td>
<td>Keep only these many records from each serie for the forecasting step. Can save time and memory if your features allow it.</td>
</tr>
<tr class="odd">
<td>refit</td>
<td>typing.Union[bool, int]</td>
<td>True</td>
<td>Retrain model for each cross validation window.<br>If False, the models are trained at the beginning and then used to predict each window.<br>If positive int, the models are retrained every <code>refit</code> windows.</td>
</tr>
<tr class="even">
<td>max_horizon</td>
<td>typing.Optional[int]</td>
<td>None</td>
<td></td>
</tr>
<tr class="odd">
<td>before_predict_callback</td>
<td>typing.Optional[typing.Callable]</td>
<td>None</td>
<td>Function to call on the features before computing the predictions.<br> This function will take the input dataframe that will be passed to the model for predicting and should return a dataframe with the same structure.<br> The series identifier is on the index.</td>
</tr>
<tr class="even">
<td>after_predict_callback</td>
<td>typing.Optional[typing.Callable]</td>
<td>None</td>
<td>Function to call on the predictions before updating the targets.<br> This function will take a pandas Series with the predictions and should return another one with the same structure.<br> The series identifier is on the index.</td>
</tr>
<tr class="odd">
<td>prediction_intervals</td>
<td>typing.Optional[mlforecast.utils.PredictionIntervals]</td>
<td>None</td>
<td>Configuration to calibrate prediction intervals (Conformal Prediction).</td>
</tr>
<tr class="even">
<td>level</td>
<td>typing.Optional[typing.List[typing.Union[int, float]]]</td>
<td>None</td>
<td>Confidence levels between 0 and 100 for prediction intervals.</td>
</tr>
<tr class="odd">
<td>input_size</td>
<td>typing.Optional[int]</td>
<td>None</td>
<td>Maximum training samples per serie in each window. If None, will use an expanding window.</td>
</tr>
<tr class="even">
<td>fitted</td>
<td>bool</td>
<td>False</td>
<td>Store the in-sample predictions.</td>
</tr>
<tr class="odd">
<td>as_numpy</td>
<td>bool</td>
<td>False</td>
<td>Cast features to numpy array.</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>typing.Union[pandas.core.frame.DataFrame, polars.dataframe.frame.DataFrame]</strong></td>
<td></td>
<td><strong>Predictions for each window with the series id, timestamp, last train date, target value and predictions from each model.</strong></td>
</tr>
</tbody>
</table>
<p>If we would like to know how good our forecast will be for a specific model and set of features then we can perform cross validation. What cross validation does is take our data and split it in two parts, where the first part is used for training and the second one for validation. Since the data is time dependant we usually take the last <em>x</em> observations from our data as the validation set.</p>
<p>This process is implemented in <code>MLForecast.cross_validation</code>, which takes our data and performs the process described above for <code>n_windows</code> times where each window has <code>h</code> validation samples in it. For example, if we have 100 samples and we want to perform 2 backtests each of size 14, the splits will be as follows:</p>
<ol type="1">
<li>Train: 1 to 72. Validation: 73 to 86.</li>
<li>Train: 1 to 86. Validation: 87 to 100.</li>
</ol>
<p>You can control the size between each cross validation window using the <code>step_size</code> argument. For example, if we have 100 samples and we want to perform 2 backtests each of size 14 and move one step ahead in each fold (<code>step_size=1</code>), the splits will be as follows:</p>
<ol type="1">
<li>Train: 1 to 85. Validation: 86 to 99.</li>
<li>Train: 1 to 86. Validation: 87 to 100.</li>
</ol>
<p>You can also perform cross validation without refitting your models for each window by setting <code>refit=False</code>. This allows you to evaluate the performance of your models using multiple window sizes without having to retrain them each time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>fcst <span class="op">=</span> MLForecast(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    models<span class="op">=</span>lgb.LGBMRegressor(random_state<span class="op">=</span><span class="dv">0</span>, verbosity<span class="op">=-</span><span class="dv">1</span>),</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    freq<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    lags<span class="op">=</span>[<span class="dv">24</span> <span class="op">*</span> (i<span class="op">+</span><span class="dv">1</span>) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">7</span>)],</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    lag_transforms<span class="op">=</span>{</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span>: [(rolling_mean, <span class="dv">24</span>)],</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>        <span class="dv">24</span>: [(rolling_mean, <span class="dv">24</span>)],</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>        <span class="dv">48</span>: [(ewm_mean, <span class="fl">0.3</span>)],</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    num_threads<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    target_transforms<span class="op">=</span>[Differences([<span class="dv">24</span>])],</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>cv_results <span class="op">=</span> fcst.cross_validation(</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    train,</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    n_windows<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    h<span class="op">=</span>horizon,</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    step_size<span class="op">=</span>horizon,</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    fitted<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>cv_results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">unique_id</th>
<th data-quarto-table-cell-role="th">ds</th>
<th data-quarto-table-cell-role="th">cutoff</th>
<th data-quarto-table-cell-role="th">y</th>
<th data-quarto-table-cell-role="th">LGBMRegressor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>H196</td>
<td>865</td>
<td>864</td>
<td>15.5</td>
<td>15.373393</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>H196</td>
<td>866</td>
<td>864</td>
<td>15.1</td>
<td>14.973393</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>H196</td>
<td>867</td>
<td>864</td>
<td>14.8</td>
<td>14.673393</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>H196</td>
<td>868</td>
<td>864</td>
<td>14.4</td>
<td>14.373393</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>H196</td>
<td>869</td>
<td>864</td>
<td>14.2</td>
<td>14.073393</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">379</td>
<td>H413</td>
<td>956</td>
<td>912</td>
<td>59.0</td>
<td>64.284167</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">380</td>
<td>H413</td>
<td>957</td>
<td>912</td>
<td>58.0</td>
<td>64.830429</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">381</td>
<td>H413</td>
<td>958</td>
<td>912</td>
<td>53.0</td>
<td>40.726851</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">382</td>
<td>H413</td>
<td>959</td>
<td>912</td>
<td>38.0</td>
<td>42.739657</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">383</td>
<td>H413</td>
<td>960</td>
<td>912</td>
<td>46.0</td>
<td>52.802769</td>
</tr>
</tbody>
</table>

<p>384 rows √ó 5 columns</p>
</div>
</div>
</div>
<p>Since we set <code>fitted=True</code> we can access the predictions for the training sets as well with the <code>cross_validation_fitted_values</code> method.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>fcst.cross_validation_fitted_values()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">unique_id</th>
<th data-quarto-table-cell-role="th">ds</th>
<th data-quarto-table-cell-role="th">fold</th>
<th data-quarto-table-cell-role="th">y</th>
<th data-quarto-table-cell-role="th">LGBMRegressor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>H196</td>
<td>193</td>
<td>0</td>
<td>12.7</td>
<td>12.673393</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>H196</td>
<td>194</td>
<td>0</td>
<td>12.3</td>
<td>12.273393</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>H196</td>
<td>195</td>
<td>0</td>
<td>11.9</td>
<td>11.873393</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>H196</td>
<td>196</td>
<td>0</td>
<td>11.7</td>
<td>11.673393</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>H196</td>
<td>197</td>
<td>0</td>
<td>11.4</td>
<td>11.473393</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5563</td>
<td>H413</td>
<td>908</td>
<td>1</td>
<td>49.0</td>
<td>50.620196</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5564</td>
<td>H413</td>
<td>909</td>
<td>1</td>
<td>39.0</td>
<td>35.972331</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5565</td>
<td>H413</td>
<td>910</td>
<td>1</td>
<td>29.0</td>
<td>29.359678</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5566</td>
<td>H413</td>
<td>911</td>
<td>1</td>
<td>24.0</td>
<td>25.784563</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5567</td>
<td>H413</td>
<td>912</td>
<td>1</td>
<td>20.0</td>
<td>23.168413</td>
</tr>
</tbody>
</table>

<p>5568 rows √ó 5 columns</p>
</div>
</div>
</div>
<p>We can also compute prediction intervals by passing a configuration to <code>prediction_intervals</code> as well as values for the width through <code>levels</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>cv_results_intervals <span class="op">=</span> fcst.cross_validation(</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    train,</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    n_windows<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    h<span class="op">=</span>horizon,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    step_size<span class="op">=</span>horizon,</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    prediction_intervals<span class="op">=</span>PredictionIntervals(h<span class="op">=</span>horizon),</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    level<span class="op">=</span>[<span class="dv">80</span>, <span class="dv">90</span>]</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>cv_results_intervals</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">unique_id</th>
<th data-quarto-table-cell-role="th">ds</th>
<th data-quarto-table-cell-role="th">cutoff</th>
<th data-quarto-table-cell-role="th">y</th>
<th data-quarto-table-cell-role="th">LGBMRegressor</th>
<th data-quarto-table-cell-role="th">LGBMRegressor-lo-90</th>
<th data-quarto-table-cell-role="th">LGBMRegressor-lo-80</th>
<th data-quarto-table-cell-role="th">LGBMRegressor-hi-80</th>
<th data-quarto-table-cell-role="th">LGBMRegressor-hi-90</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>H196</td>
<td>865</td>
<td>864</td>
<td>15.5</td>
<td>15.373393</td>
<td>15.311379</td>
<td>15.316528</td>
<td>15.430258</td>
<td>15.435407</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>H196</td>
<td>866</td>
<td>864</td>
<td>15.1</td>
<td>14.973393</td>
<td>14.940556</td>
<td>14.940556</td>
<td>15.006230</td>
<td>15.006230</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>H196</td>
<td>867</td>
<td>864</td>
<td>14.8</td>
<td>14.673393</td>
<td>14.606230</td>
<td>14.606230</td>
<td>14.740556</td>
<td>14.740556</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>H196</td>
<td>868</td>
<td>864</td>
<td>14.4</td>
<td>14.373393</td>
<td>14.306230</td>
<td>14.306230</td>
<td>14.440556</td>
<td>14.440556</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>H196</td>
<td>869</td>
<td>864</td>
<td>14.2</td>
<td>14.073393</td>
<td>14.006230</td>
<td>14.006230</td>
<td>14.140556</td>
<td>14.140556</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">379</td>
<td>H413</td>
<td>956</td>
<td>912</td>
<td>59.0</td>
<td>64.284167</td>
<td>29.890099</td>
<td>34.371545</td>
<td>94.196788</td>
<td>98.678234</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">380</td>
<td>H413</td>
<td>957</td>
<td>912</td>
<td>58.0</td>
<td>64.830429</td>
<td>56.874572</td>
<td>57.827689</td>
<td>71.833169</td>
<td>72.786285</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">381</td>
<td>H413</td>
<td>958</td>
<td>912</td>
<td>53.0</td>
<td>40.726851</td>
<td>35.296195</td>
<td>35.846206</td>
<td>45.607495</td>
<td>46.157506</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">382</td>
<td>H413</td>
<td>959</td>
<td>912</td>
<td>38.0</td>
<td>42.739657</td>
<td>35.292153</td>
<td>35.807640</td>
<td>49.671674</td>
<td>50.187161</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">383</td>
<td>H413</td>
<td>960</td>
<td>912</td>
<td>46.0</td>
<td>52.802769</td>
<td>42.465597</td>
<td>43.895670</td>
<td>61.709869</td>
<td>63.139941</td>
</tr>
</tbody>
</table>

<p>384 rows √ó 9 columns</p>
</div>
</div>
</div>
<p>The <code>refit</code> argument allows us to control if we want to retrain the models in every window. It can either be:</p>
<ul>
<li>A boolean: True will retrain on every window and False only on the first one.</li>
<li>A positive integer: The models will be trained on the first window and then every <code>refit</code> windows.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>fcst <span class="op">=</span> MLForecast(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    models<span class="op">=</span>LinearRegression(),</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    freq<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    lags<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">24</span>],</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> refit, expected_models <span class="kw">in</span> <span class="bu">zip</span>([<span class="va">True</span>, <span class="va">False</span>, <span class="dv">2</span>], [<span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">2</span>]):</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    fcst.cross_validation(</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>        train,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>        n_windows<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>        h<span class="op">=</span>horizon,</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>        refit<span class="op">=</span>refit,</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    test_eq(<span class="bu">len</span>(fcst.cv_models_), expected_models)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plot_series(cv_results, cv_results.drop(columns<span class="op">=</span><span class="st">'cutoff'</span>), max_insample_length<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="figs/forecast__cross_validation.png" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plot_series(cv_results_intervals, cv_results_intervals.drop(columns<span class="op">=</span><span class="st">'cutoff'</span>), level<span class="op">=</span>[<span class="dv">90</span>], max_insample_length<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="figs/forecast__cross_validation_intervals.png" class="img-fluid"></p>
<hr>
</section>
<section id="mlforecast.from_cv" class="level3">
<h3 class="anchored" data-anchor-id="mlforecast.from_cv">MLForecast.from_cv</h3>
<blockquote class="blockquote">
<pre><code> MLForecast.from_cv (cv:mlforecast.lgb_cv.LightGBMCV)</code></pre>
</blockquote>
<p>Once you‚Äôve found a set of features and parameters that work for your problem you can build a forecast object from it using <code>MLForecast.from_cv</code>, which takes the trained <code>LightGBMCV</code> object and builds an <code>MLForecast</code> object that will use the same features and parameters. Then you can call fit and predict as you normally would.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> LightGBMCV(</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    freq<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    lags<span class="op">=</span>[<span class="dv">24</span> <span class="op">*</span> (i<span class="op">+</span><span class="dv">1</span>) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">7</span>)],</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    lag_transforms<span class="op">=</span>{</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>        <span class="dv">48</span>: [(ewm_mean, <span class="fl">0.3</span>)],</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    num_threads<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    target_transforms<span class="op">=</span>[Differences([<span class="dv">24</span>])]</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>hist <span class="op">=</span> cv.fit(</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    train,</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    n_windows<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    h<span class="op">=</span>horizon,</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>    params<span class="op">=</span>{<span class="st">'verbosity'</span>: <span class="op">-</span><span class="dv">1</span>},</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[LightGBM] [Info] Start training from score 0.084340
[10] mape: 0.118569
[20] mape: 0.111506
[30] mape: 0.107314
[40] mape: 0.106089
[50] mape: 0.106630
Early stopping at round 50
Using best iteration: 40</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>fcst <span class="op">=</span> MLForecast.from_cv(cv)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> cv.best_iteration_ <span class="op">==</span> fcst.models[<span class="st">'LGBMRegressor'</span>].n_estimators</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>fcst.fit(train)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>fcst.predict(horizon)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">unique_id</th>
<th data-quarto-table-cell-role="th">ds</th>
<th data-quarto-table-cell-role="th">LGBMRegressor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>H196</td>
<td>961</td>
<td>16.111079</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>H196</td>
<td>962</td>
<td>15.711079</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>H196</td>
<td>963</td>
<td>15.311079</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>H196</td>
<td>964</td>
<td>15.011079</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>H196</td>
<td>965</td>
<td>14.711079</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">187</td>
<td>H413</td>
<td>1004</td>
<td>92.722032</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">188</td>
<td>H413</td>
<td>1005</td>
<td>69.153603</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">189</td>
<td>H413</td>
<td>1006</td>
<td>68.811675</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">190</td>
<td>H413</td>
<td>1007</td>
<td>53.693346</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">191</td>
<td>H413</td>
<td>1008</td>
<td>46.055481</td>
</tr>
</tbody>
</table>

<p>192 rows √ó 3 columns</p>
</div>
</div>
</div>


</section>

<p>Give us a ‚≠ê on <a href="https://github.com/nixtla/mlforecast">Github</a></p></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>