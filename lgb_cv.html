<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Time series cross validation with LightGBM.">

<title>mlforecast - LightGBMCV</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-NXJNCVR18L"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-NXJNCVR18L', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="mlforecast - LightGBMCV">
<meta property="og:description" content="Time series cross validation with LightGBM.">
<meta property="og:image" content="https://github.com/Nixtla/styles/blob/2abf51612584169874c90cd7c4d347e3917eaf73/images/Banner%20Github.png">
<meta property="og:site-name" content="mlforecast">
<meta name="twitter:title" content="mlforecast - LightGBMCV">
<meta name="twitter:description" content="Time series cross validation with LightGBM.">
<meta name="twitter:image" content="https://farm6.staticflickr.com/5510/14338202952_93595258ff_z.jpg">
<meta name="twitter:site" content="@Nixtlainc">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">mlforecast</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./docs/getting-started/quick_start_local.html" rel="" target="" aria-current="page">
 <span class="menu-text">Get Started</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-nixtlaverse" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">NixtlaVerse</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-nixtlaverse">    
        <li>
    <a class="dropdown-item" href="https://github.com/nixtla/statsforecast" rel="" target="">
 <span class="dropdown-text">StatsForecast ‚ö°Ô∏è</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/nixtla/neuralforecast" rel="" target="">
 <span class="dropdown-text">NeuralForecast üß†</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/nixtla/hierarchicalforecast" rel="" target="">
 <span class="dropdown-text">HierarchicalForecast üëë</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-help" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Help</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-help">    
        <li>
    <a class="dropdown-item" href="https://github.com/nixtla/mlforecast/issues/new/choose" rel="" target=""><i class="bi bi-bug" role="img">
</i> 
 <span class="dropdown-text">Report an Issue</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://join.slack.com/t/nixtlaworkspace/shared_invite/zt-135dssye9-fWTzMpv2WBthq8NK0Yvu6A" rel="" target=""><i class="bi bi-chat-right-text" role="img">
</i> 
 <span class="dropdown-text">Join our Slack</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/nixtla/mlforecast" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/nixtlainc" rel="" target=""><i class="bi bi-twitter" role="img" aria-label="Nixtla Twitter">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">API reference</li><li class="breadcrumb-item"><a href="./forecast.html">Local</a></li><li class="breadcrumb-item"><a href="./lgb_cv.html">LightGBMCV</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">mlforecast</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">
 <span class="menu-text">Getting started</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/getting-started/install.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Install</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/getting-started/quick_start_local.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quick start (local)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/getting-started/quick_start_distributed.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quick start (distributed)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/getting-started/end_to_end_walkthrough.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">End to end walkthrough</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">How-to guides</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/exogenous_features.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exogenous features</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/lag_transforms_guide.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lag transformations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/transforming_exog.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transforming exogenous features</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/cross_validation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Cross validation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/prediction_intervals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Probabilistic forecasting</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/target_transforms_guide.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Target transformations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/analyzing_models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analyzing the trained models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/custom_training.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Custom training</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/training_with_numpy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Training with numpy arrays</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/one_model_per_horizon.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">One model per step</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/custom_date_features.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Custom date features</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/predict_callbacks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Predict callbacks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/predict_subset.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Predicting a subset of ids</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/how-to-guides/transfer_learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transfer Learning</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/tutorials/electricity_load_forecasting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Electricity Load Forecast</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/tutorials/electricity_peak_forecasting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Detect Demand Peaks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docs/tutorials/prediction_intervals_in_forecasting_models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prediction intervals</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">API reference</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Local</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./forecast.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MLForecast</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lgb_cv.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">LightGBMCV</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Utils</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./core.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Core</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./target_transforms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Target transforms</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lag_transforms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lag transforms</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./feature_engineering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Feature engineering</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./callbacks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Callbacks</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false">
 <span class="menu-text">Distributed</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./distributed.forecast.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Distributed Forecast</span></a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false">
 <span class="menu-text">Models</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./distributed.models.dask.lgb.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DaskLGBMForecast</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./distributed.models.dask.xgb.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DaskXGBForecast</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./distributed.models.ray.lgb.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">RayLGBMForecast</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./distributed.models.ray.xgb.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">RayXGBForecast</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./distributed.models.spark.lgb.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SparkLGBMForecast</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./distributed.models.spark.xgb.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SparkXGBForecast</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#lightgbmcv" id="toc-lightgbmcv" class="nav-link active" data-scroll-target="#lightgbmcv">LightGBMCV</a></li>
  <li><a href="#example" id="toc-example" class="nav-link" data-scroll-target="#example">Example</a>
  <ul class="collapse">
  <li><a href="#lightgbmcv.fit" id="toc-lightgbmcv.fit" class="nav-link" data-scroll-target="#lightgbmcv.fit">LightGBMCV.fit</a></li>
  <li><a href="#lightgbmcv.predict" id="toc-lightgbmcv.predict" class="nav-link" data-scroll-target="#lightgbmcv.predict">LightGBMCV.predict</a></li>
  <li><a href="#lightgbmcv.setup" id="toc-lightgbmcv.setup" class="nav-link" data-scroll-target="#lightgbmcv.setup">LightGBMCV.setup</a></li>
  <li><a href="#lightgbmcv.partial_fit" id="toc-lightgbmcv.partial_fit" class="nav-link" data-scroll-target="#lightgbmcv.partial_fit">LightGBMCV.partial_fit</a></li>
  <li><a href="#using-a-custom-metric" id="toc-using-a-custom-metric" class="nav-link" data-scroll-target="#using-a-custom-metric">Using a custom metric</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/Nixtla/mlforecast/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">LightGBMCV</h1>
</div>

<div>
  <div class="description">
    Time series cross validation with LightGBM.
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<hr>
<section id="lightgbmcv" class="level3">
<h3 class="anchored" data-anchor-id="lightgbmcv">LightGBMCV</h3>
<blockquote class="blockquote">
<pre><code> LightGBMCV (freq:Union[int,str,pandas._libs.tslibs.offsets.BaseOffset,Non
             eType]=None, lags:Optional[Iterable[int]]=None, lag_transform
             s:Optional[Dict[int,List[Union[Callable,Tuple[Callable,Any]]]
             ]]=None,
             date_features:Optional[Iterable[Union[str,Callable]]]=None,
             num_threads:int=1, target_transforms:Optional[List[Union[mlfo
             recast.target_transforms.BaseTargetTransform,mlforecast.targe
             t_transforms.BaseGroupedArrayTargetTransform]]]=None)</code></pre>
</blockquote>
<p>Create LightGBM CV object.</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>freq</td>
<td>typing.Union[int, str, pandas._libs.tslibs.offsets.BaseOffset, NoneType]</td>
<td>None</td>
<td>Pandas offset alias, e.g.&nbsp;‚ÄòD‚Äô, ‚ÄòW-THU‚Äô or integer denoting the frequency of the series.</td>
</tr>
<tr class="even">
<td>lags</td>
<td>typing.Optional[typing.Iterable[int]]</td>
<td>None</td>
<td>Lags of the target to use as features.</td>
</tr>
<tr class="odd">
<td>lag_transforms</td>
<td>typing.Optional[typing.Dict[int, typing.List[typing.Union[typing.Callable, typing.Tuple[typing.Callable, typing.Any]]]]]</td>
<td>None</td>
<td>Mapping of target lags to their transformations.</td>
</tr>
<tr class="even">
<td>date_features</td>
<td>typing.Optional[typing.Iterable[typing.Union[str, typing.Callable]]]</td>
<td>None</td>
<td>Features computed from the dates. Can be pandas date attributes or functions that will take the dates as input.</td>
</tr>
<tr class="odd">
<td>num_threads</td>
<td>int</td>
<td>1</td>
<td>Number of threads to use when computing the features.</td>
</tr>
<tr class="even">
<td>target_transforms</td>
<td>typing.Optional[typing.List[typing.Union[mlforecast.target_transforms.BaseTargetTransform, mlforecast.target_transforms.BaseGroupedArrayTargetTransform]]]</td>
<td>None</td>
<td>Transformations that will be applied to the target before computing the features and restored after the forecasting step.</td>
</tr>
</tbody>
</table>
</section>
<section id="example" class="level2">
<h2 class="anchored" data-anchor-id="example">Example</h2>
<p>This shows an example with just 4 series of the M4 dataset. If you want to run it yourself on all of them, you can refer to <a href="https://www.kaggle.com/code/lemuz90/m4-competition-cv">this notebook</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datasetsforecast.m4 <span class="im">import</span> M4, M4Info</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.test <span class="im">import</span> test_eq, test_fail</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mlforecast.target_transforms <span class="im">import</span> Differences</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> nbdev <span class="im">import</span> show_doc</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> window_ops.ewm <span class="im">import</span> ewm_mean</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> window_ops.rolling <span class="im">import</span> rolling_mean, seasonal_rolling_mean</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>group <span class="op">=</span> <span class="st">'Hourly'</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> M4.async_download(<span class="st">'data'</span>, group<span class="op">=</span>group)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>df, <span class="op">*</span>_ <span class="op">=</span> M4.load(directory<span class="op">=</span><span class="st">'data'</span>, group<span class="op">=</span>group)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'ds'</span>] <span class="op">=</span> df[<span class="st">'ds'</span>].astype(<span class="st">'int'</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>ids <span class="op">=</span> df[<span class="st">'unique_id'</span>].unique()</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">0</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>sample_ids <span class="op">=</span> random.choices(ids, k<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>sample_df <span class="op">=</span> df[df[<span class="st">'unique_id'</span>].isin(sample_ids)]</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>sample_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">unique_id</th>
<th data-quarto-table-cell-role="th">ds</th>
<th data-quarto-table-cell-role="th">y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">86796</td>
<td>H196</td>
<td>1</td>
<td>11.8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">86797</td>
<td>H196</td>
<td>2</td>
<td>11.4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">86798</td>
<td>H196</td>
<td>3</td>
<td>11.1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">86799</td>
<td>H196</td>
<td>4</td>
<td>10.8</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">86800</td>
<td>H196</td>
<td>5</td>
<td>10.6</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">325235</td>
<td>H413</td>
<td>1004</td>
<td>99.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">325236</td>
<td>H413</td>
<td>1005</td>
<td>88.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">325237</td>
<td>H413</td>
<td>1006</td>
<td>47.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">325238</td>
<td>H413</td>
<td>1007</td>
<td>41.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">325239</td>
<td>H413</td>
<td>1008</td>
<td>34.0</td>
</tr>
</tbody>
</table>

<p>4032 rows √ó 3 columns</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>info <span class="op">=</span> M4Info[group]</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>horizon <span class="op">=</span> info.horizon</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> sample_df.groupby(<span class="st">'unique_id'</span>).tail(horizon)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> sample_df.drop(valid.index)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>train.shape, valid.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>((3840, 3), (192, 3))</code></pre>
</div>
</div>
<p>What LightGBMCV does is emulate <a href="https://lightgbm.readthedocs.io/en/v3.3.2/pythonapi/lightgbm.cv.html#lightgbm.cv">LightGBM‚Äôs cv function</a> where several Boosters are trained simultaneously on different partitions of the data, that is, one boosting iteration is performed on all of them at a time. This allows to have an estimate of the error by iteration, so if we combine this with early stopping we can find the best iteration to train a final model using all the data or even use these individual models‚Äô predictions to compute an ensemble.</p>
<p>In order to have a good estimate of the forecasting performance of our model we compute predictions for the whole test period and compute a metric on that. Since this step can slow down training, there‚Äôs an <code>eval_every</code> parameter that can be used to control this, that is, if <code>eval_every=10</code> (the default) every 10 boosting iterations we‚Äôre going to compute forecasts for the complete window and report the error.</p>
<p>We also have early stopping parameters:</p>
<ul>
<li><code>early_stopping_evals</code>: how many evaluations of the full window should we go without improving to stop training?</li>
<li><code>early_stopping_pct</code>: what‚Äôs the minimum percentage improvement we want in these <code>early_stopping_evals</code> in order to keep training?</li>
</ul>
<p>This makes the LightGBMCV class a good tool to quickly test different configurations of the model. Consider the following example, where we‚Äôre going to try to find out which features can improve the performance of our model. We start just using lags.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>static_fit_config <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    n_windows<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    h<span class="op">=</span>horizon,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    params<span class="op">=</span>{<span class="st">'verbose'</span>: <span class="op">-</span><span class="dv">1</span>},</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    compute_cv_preds<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> LightGBMCV(</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    freq<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    lags<span class="op">=</span>[<span class="dv">24</span> <span class="op">*</span> (i<span class="op">+</span><span class="dv">1</span>) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">7</span>)],  <span class="co"># one week of lags</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<section id="lightgbmcv.fit" class="level3">
<h3 class="anchored" data-anchor-id="lightgbmcv.fit">LightGBMCV.fit</h3>
<blockquote class="blockquote">
<pre><code> LightGBMCV.fit (df:pandas.core.frame.DataFrame, n_windows:int, h:int,
                 id_col:str='unique_id', time_col:str='ds',
                 target_col:str='y', step_size:Optional[int]=None,
                 num_iterations:int=100,
                 params:Optional[Dict[str,Any]]=None,
                 static_features:Optional[List[str]]=None,
                 dropna:bool=True, keep_last_n:Optional[int]=None,
                 eval_every:int=10,
                 weights:Optional[Sequence[float]]=None,
                 metric:Union[str,Callable]='mape',
                 verbose_eval:bool=True, early_stopping_evals:int=2,
                 early_stopping_pct:float=0.01,
                 compute_cv_preds:bool=False,
                 before_predict_callback:Optional[Callable]=None,
                 after_predict_callback:Optional[Callable]=None,
                 input_size:Optional[int]=None)</code></pre>
</blockquote>
<p>Train boosters simultaneously and assess their performance on the complete forecasting window.</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>df</td>
<td>DataFrame</td>
<td></td>
<td>Series data in long format.</td>
</tr>
<tr class="even">
<td>n_windows</td>
<td>int</td>
<td></td>
<td>Number of windows to evaluate.</td>
</tr>
<tr class="odd">
<td>h</td>
<td>int</td>
<td></td>
<td>Forecast horizon.</td>
</tr>
<tr class="even">
<td>id_col</td>
<td>str</td>
<td>unique_id</td>
<td>Column that identifies each serie.</td>
</tr>
<tr class="odd">
<td>time_col</td>
<td>str</td>
<td>ds</td>
<td>Column that identifies each timestep, its values can be timestamps or integers.</td>
</tr>
<tr class="even">
<td>target_col</td>
<td>str</td>
<td>y</td>
<td>Column that contains the target.</td>
</tr>
<tr class="odd">
<td>step_size</td>
<td>typing.Optional[int]</td>
<td>None</td>
<td>Step size between each cross validation window. If None it will be equal to <code>h</code>.</td>
</tr>
<tr class="even">
<td>num_iterations</td>
<td>int</td>
<td>100</td>
<td>Maximum number of boosting iterations to run.</td>
</tr>
<tr class="odd">
<td>params</td>
<td>typing.Optional[typing.Dict[str, typing.Any]]</td>
<td>None</td>
<td>Parameters to be passed to the LightGBM Boosters.</td>
</tr>
<tr class="even">
<td>static_features</td>
<td>typing.Optional[typing.List[str]]</td>
<td>None</td>
<td>Names of the features that are static and will be repeated when forecasting.</td>
</tr>
<tr class="odd">
<td>dropna</td>
<td>bool</td>
<td>True</td>
<td>Drop rows with missing values produced by the transformations.</td>
</tr>
<tr class="even">
<td>keep_last_n</td>
<td>typing.Optional[int]</td>
<td>None</td>
<td>Keep only these many records from each serie for the forecasting step. Can save time and memory if your features allow it.</td>
</tr>
<tr class="odd">
<td>eval_every</td>
<td>int</td>
<td>10</td>
<td>Number of boosting iterations to train before evaluating on the whole forecast window.</td>
</tr>
<tr class="even">
<td>weights</td>
<td>typing.Optional[typing.Sequence[float]]</td>
<td>None</td>
<td>Weights to multiply the metric of each window. If None, all windows have the same weight.</td>
</tr>
<tr class="odd">
<td>metric</td>
<td>typing.Union[str, typing.Callable]</td>
<td>mape</td>
<td>Metric used to assess the performance of the models and perform early stopping.</td>
</tr>
<tr class="even">
<td>verbose_eval</td>
<td>bool</td>
<td>True</td>
<td>Print the metrics of each evaluation.</td>
</tr>
<tr class="odd">
<td>early_stopping_evals</td>
<td>int</td>
<td>2</td>
<td>Maximum number of evaluations to run without improvement.</td>
</tr>
<tr class="even">
<td>early_stopping_pct</td>
<td>float</td>
<td>0.01</td>
<td>Minimum percentage improvement in metric value in <code>early_stopping_evals</code> evaluations.</td>
</tr>
<tr class="odd">
<td>compute_cv_preds</td>
<td>bool</td>
<td>False</td>
<td>Compute predictions for each window after finding the best iteration.</td>
</tr>
<tr class="even">
<td>before_predict_callback</td>
<td>typing.Optional[typing.Callable]</td>
<td>None</td>
<td>Function to call on the features before computing the predictions.<br> This function will take the input dataframe that will be passed to the model for predicting and should return a dataframe with the same structure.<br> The series identifier is on the index.</td>
</tr>
<tr class="odd">
<td>after_predict_callback</td>
<td>typing.Optional[typing.Callable]</td>
<td>None</td>
<td>Function to call on the predictions before updating the targets.<br> This function will take a pandas Series with the predictions and should return another one with the same structure.<br> The series identifier is on the index.</td>
</tr>
<tr class="even">
<td>input_size</td>
<td>typing.Optional[int]</td>
<td>None</td>
<td>Maximum training samples per serie in each window. If None, will use an expanding window.</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>typing.List[typing.Tuple[int, float]]</strong></td>
<td></td>
<td><strong>List of (boosting rounds, metric value) tuples.</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>hist <span class="op">=</span> cv.fit(train, <span class="op">**</span>static_fit_config)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[LightGBM] [Info] Start training from score 51.745632
[10] mape: 0.590690
[20] mape: 0.251093
[30] mape: 0.143643
[40] mape: 0.109723
[50] mape: 0.102099
[60] mape: 0.099448
[70] mape: 0.098349
[80] mape: 0.098006
[90] mape: 0.098718
Early stopping at round 90
Using best iteration: 80</code></pre>
</div>
</div>
<p>By setting <code>compute_cv_preds</code> we get the predictions from each model on their corresponding validation fold.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>cv.cv_preds_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">unique_id</th>
<th data-quarto-table-cell-role="th">ds</th>
<th data-quarto-table-cell-role="th">y</th>
<th data-quarto-table-cell-role="th">Booster</th>
<th data-quarto-table-cell-role="th">window</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>H196</td>
<td>865</td>
<td>15.5</td>
<td>15.522924</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>H196</td>
<td>866</td>
<td>15.1</td>
<td>14.985832</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>H196</td>
<td>867</td>
<td>14.8</td>
<td>14.667901</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>H196</td>
<td>868</td>
<td>14.4</td>
<td>14.514592</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>H196</td>
<td>869</td>
<td>14.2</td>
<td>14.035793</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">187</td>
<td>H413</td>
<td>956</td>
<td>59.0</td>
<td>77.227905</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">188</td>
<td>H413</td>
<td>957</td>
<td>58.0</td>
<td>80.589641</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">189</td>
<td>H413</td>
<td>958</td>
<td>53.0</td>
<td>53.986834</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">190</td>
<td>H413</td>
<td>959</td>
<td>38.0</td>
<td>36.749786</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">191</td>
<td>H413</td>
<td>960</td>
<td>46.0</td>
<td>36.281225</td>
<td>1</td>
</tr>
</tbody>
</table>

<p>384 rows √ó 5 columns</p>
</div>
</div>
</div>
<p>The individual models we trained are saved, so calling <code>predict</code> returns the predictions from every model trained.</p>
<hr>
</section>
<section id="lightgbmcv.predict" class="level3">
<h3 class="anchored" data-anchor-id="lightgbmcv.predict">LightGBMCV.predict</h3>
<blockquote class="blockquote">
<pre><code> LightGBMCV.predict (h:int,
                     before_predict_callback:Optional[Callable]=None,
                     after_predict_callback:Optional[Callable]=None,
                     X_df:Optional[pandas.core.frame.DataFrame]=None)</code></pre>
</blockquote>
<p>Compute predictions with each of the trained boosters.</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>h</td>
<td>int</td>
<td></td>
<td>Forecast horizon.</td>
</tr>
<tr class="even">
<td>before_predict_callback</td>
<td>typing.Optional[typing.Callable]</td>
<td>None</td>
<td>Function to call on the features before computing the predictions.<br> This function will take the input dataframe that will be passed to the model for predicting and should return a dataframe with the same structure.<br> The series identifier is on the index.</td>
</tr>
<tr class="odd">
<td>after_predict_callback</td>
<td>typing.Optional[typing.Callable]</td>
<td>None</td>
<td>Function to call on the predictions before updating the targets.<br> This function will take a pandas Series with the predictions and should return another one with the same structure.<br> The series identifier is on the index.</td>
</tr>
<tr class="even">
<td>X_df</td>
<td>typing.Optional[pandas.core.frame.DataFrame]</td>
<td>None</td>
<td>Dataframe with the future exogenous features. Should have the id column and the time column.</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>DataFrame</strong></td>
<td></td>
<td><strong>Predictions for each serie and timestep, with one column per window.</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> cv.predict(horizon)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>preds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">unique_id</th>
<th data-quarto-table-cell-role="th">ds</th>
<th data-quarto-table-cell-role="th">Booster0</th>
<th data-quarto-table-cell-role="th">Booster1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>H196</td>
<td>961</td>
<td>15.670252</td>
<td>15.848888</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>H196</td>
<td>962</td>
<td>15.522924</td>
<td>15.697399</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>H196</td>
<td>963</td>
<td>14.985832</td>
<td>15.166213</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>H196</td>
<td>964</td>
<td>14.985832</td>
<td>14.723238</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>H196</td>
<td>965</td>
<td>14.562152</td>
<td>14.451092</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">187</td>
<td>H413</td>
<td>1004</td>
<td>70.695242</td>
<td>65.917620</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">188</td>
<td>H413</td>
<td>1005</td>
<td>66.216580</td>
<td>62.615788</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">189</td>
<td>H413</td>
<td>1006</td>
<td>63.896573</td>
<td>67.848598</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">190</td>
<td>H413</td>
<td>1007</td>
<td>46.922797</td>
<td>50.981950</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">191</td>
<td>H413</td>
<td>1008</td>
<td>45.006541</td>
<td>42.752819</td>
</tr>
</tbody>
</table>

<p>192 rows √ó 4 columns</p>
</div>
</div>
</div>
<p>We can average these predictions and evaluate them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_on_valid(preds):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> preds.copy()</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    preds[<span class="st">'final_prediction'</span>] <span class="op">=</span> preds.drop(columns<span class="op">=</span>[<span class="st">'unique_id'</span>, <span class="st">'ds'</span>]).mean(<span class="dv">1</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> preds.merge(valid, on<span class="op">=</span>[<span class="st">'unique_id'</span>, <span class="st">'ds'</span>])</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">'abs_err'</span>] <span class="op">=</span> <span class="bu">abs</span>(merged[<span class="st">'final_prediction'</span>] <span class="op">-</span> merged[<span class="st">'y'</span>]) <span class="op">/</span> merged[<span class="st">'y'</span>]</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> merged.groupby(<span class="st">'unique_id'</span>)[<span class="st">'abs_err'</span>].mean().mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>eval1 <span class="op">=</span> evaluate_on_valid(preds)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>eval1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>0.11036194712311806</code></pre>
</div>
</div>
<p>Now, since these series are hourly, maybe we can try to remove the daily seasonality by taking the 168th (24 * 7) difference, that is, substract the value at the same hour from one week ago, thus our target will be <span class="math inline">\(z_t = y_{t} - y_{t-168}\)</span>. The features will be computed from this target and when we predict they will be automatically re-applied.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>cv2 <span class="op">=</span> LightGBMCV(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    freq<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    target_transforms<span class="op">=</span>[Differences([<span class="dv">24</span> <span class="op">*</span> <span class="dv">7</span>])],</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    lags<span class="op">=</span>[<span class="dv">24</span> <span class="op">*</span> (i<span class="op">+</span><span class="dv">1</span>) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">7</span>)],</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>hist2 <span class="op">=</span> cv2.fit(train, <span class="op">**</span>static_fit_config)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[LightGBM] [Info] Start training from score 0.519010
[10] mape: 0.089024
[20] mape: 0.090683
[30] mape: 0.092316
Early stopping at round 30
Using best iteration: 10</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> hist2[<span class="op">-</span><span class="dv">1</span>][<span class="dv">1</span>] <span class="op">&lt;</span> hist[<span class="op">-</span><span class="dv">1</span>][<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Nice! We achieve a better score in less iterations. Let‚Äôs see if this improvement translates to the validation set as well.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>preds2 <span class="op">=</span> cv2.predict(horizon)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>eval2 <span class="op">=</span> evaluate_on_valid(preds2)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>eval2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>0.08956665504570135</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> eval2 <span class="op">&lt;</span> eval1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Great! Maybe we can try some lag transforms now. We‚Äôll try the seasonal rolling mean that averages the values ‚Äúevery season‚Äù, that is, if we set <code>season_length=24</code> and <code>window_size=7</code> then we‚Äôll average the value at the same hour for every day of the week.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>cv3 <span class="op">=</span> LightGBMCV(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    freq<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    target_transforms<span class="op">=</span>[Differences([<span class="dv">24</span> <span class="op">*</span> <span class="dv">7</span>])],</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    lags<span class="op">=</span>[<span class="dv">24</span> <span class="op">*</span> (i<span class="op">+</span><span class="dv">1</span>) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">7</span>)],</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    lag_transforms<span class="op">=</span>{</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>        <span class="dv">48</span>: [(seasonal_rolling_mean, <span class="dv">24</span>, <span class="dv">7</span>)],</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>hist3 <span class="op">=</span> cv3.fit(train, <span class="op">**</span>static_fit_config)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[LightGBM] [Info] Start training from score 0.273641
[10] mape: 0.086724
[20] mape: 0.088466
[30] mape: 0.090536
Early stopping at round 30
Using best iteration: 10</code></pre>
</div>
</div>
<p>Seems like this is helping as well!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> hist3[<span class="op">-</span><span class="dv">1</span>][<span class="dv">1</span>] <span class="op">&lt;</span> hist2[<span class="op">-</span><span class="dv">1</span>][<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Does this reflect on the validation set?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>preds3 <span class="op">=</span> cv3.predict(horizon)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>eval3 <span class="op">=</span> evaluate_on_valid(preds3)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>eval3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>0.08961279023129345</code></pre>
</div>
</div>
<p>Nice! mlforecast also supports date features, but in this case our time column is made from integers so there aren‚Äôt many possibilites here. As you can see this allows you to iterate faster and get better estimates of the forecasting performance you can expect from your model.</p>
<p>If you‚Äôre doing hyperparameter tuning it‚Äôs useful to be able to run a couple of iterations, assess the performance, and determine if this particular configuration isn‚Äôt promising and should be discarded. For example, <a href="https://optuna.org/">optuna</a> has <a href="https://optuna.readthedocs.io/en/stable/reference/pruners.html">pruners</a> that you can call with your current score and it decides if the trial should be discarded. We‚Äôll now show how to do that.</p>
<p>Since the CV requires a bit of setup, like the LightGBM datasets and the internal features, we have this <code>setup</code> method.</p>
<hr>
</section>
<section id="lightgbmcv.setup" class="level3">
<h3 class="anchored" data-anchor-id="lightgbmcv.setup">LightGBMCV.setup</h3>
<blockquote class="blockquote">
<pre><code> LightGBMCV.setup (df:pandas.core.frame.DataFrame, n_windows:int, h:int,
                   id_col:str='unique_id', time_col:str='ds',
                   target_col:str='y', step_size:Optional[int]=None,
                   params:Optional[Dict[str,Any]]=None,
                   static_features:Optional[List[str]]=None,
                   dropna:bool=True, keep_last_n:Optional[int]=None,
                   weights:Optional[Sequence[float]]=None,
                   metric:Union[str,Callable]='mape',
                   input_size:Optional[int]=None)</code></pre>
</blockquote>
<p>Initialize internal data structures to iteratively train the boosters. Use this before calling partial_fit.</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>df</td>
<td>DataFrame</td>
<td></td>
<td>Series data in long format.</td>
</tr>
<tr class="even">
<td>n_windows</td>
<td>int</td>
<td></td>
<td>Number of windows to evaluate.</td>
</tr>
<tr class="odd">
<td>h</td>
<td>int</td>
<td></td>
<td>Forecast horizon.</td>
</tr>
<tr class="even">
<td>id_col</td>
<td>str</td>
<td>unique_id</td>
<td>Column that identifies each serie.</td>
</tr>
<tr class="odd">
<td>time_col</td>
<td>str</td>
<td>ds</td>
<td>Column that identifies each timestep, its values can be timestamps or integers.</td>
</tr>
<tr class="even">
<td>target_col</td>
<td>str</td>
<td>y</td>
<td>Column that contains the target.</td>
</tr>
<tr class="odd">
<td>step_size</td>
<td>typing.Optional[int]</td>
<td>None</td>
<td>Step size between each cross validation window. If None it will be equal to <code>h</code>.</td>
</tr>
<tr class="even">
<td>params</td>
<td>typing.Optional[typing.Dict[str, typing.Any]]</td>
<td>None</td>
<td>Parameters to be passed to the LightGBM Boosters.</td>
</tr>
<tr class="odd">
<td>static_features</td>
<td>typing.Optional[typing.List[str]]</td>
<td>None</td>
<td>Names of the features that are static and will be repeated when forecasting.</td>
</tr>
<tr class="even">
<td>dropna</td>
<td>bool</td>
<td>True</td>
<td>Drop rows with missing values produced by the transformations.</td>
</tr>
<tr class="odd">
<td>keep_last_n</td>
<td>typing.Optional[int]</td>
<td>None</td>
<td>Keep only these many records from each serie for the forecasting step. Can save time and memory if your features allow it.</td>
</tr>
<tr class="even">
<td>weights</td>
<td>typing.Optional[typing.Sequence[float]]</td>
<td>None</td>
<td>Weights to multiply the metric of each window. If None, all windows have the same weight.</td>
</tr>
<tr class="odd">
<td>metric</td>
<td>typing.Union[str, typing.Callable]</td>
<td>mape</td>
<td>Metric used to assess the performance of the models and perform early stopping.</td>
</tr>
<tr class="even">
<td>input_size</td>
<td>typing.Optional[int]</td>
<td>None</td>
<td>Maximum training samples per serie in each window. If None, will use an expanding window.</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>LightGBMCV</strong></td>
<td></td>
<td><strong>CV object with internal data structures for partial_fit.</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>cv4 <span class="op">=</span> LightGBMCV(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    freq<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    lags<span class="op">=</span>[<span class="dv">24</span> <span class="op">*</span> (i<span class="op">+</span><span class="dv">1</span>) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">7</span>)],</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>cv4.setup(</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    train,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    n_windows<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    h<span class="op">=</span>horizon,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    params<span class="op">=</span>{<span class="st">'verbose'</span>: <span class="op">-</span><span class="dv">1</span>},</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>LightGBMCV(freq=1, lag_features=['lag24', 'lag48', 'lag72', 'lag96', 'lag120', 'lag144', 'lag168'], date_features=[], num_threads=1, bst_threads=8)</code></pre>
</div>
</div>
<p>Once we have this we can call <code>partial_fit</code> to only train for some iterations and return the score of the forecast window.</p>
<hr>
</section>
<section id="lightgbmcv.partial_fit" class="level3">
<h3 class="anchored" data-anchor-id="lightgbmcv.partial_fit">LightGBMCV.partial_fit</h3>
<blockquote class="blockquote">
<pre><code> LightGBMCV.partial_fit (num_iterations:int,
                         before_predict_callback:Optional[Callable]=None,
                         after_predict_callback:Optional[Callable]=None)</code></pre>
</blockquote>
<p>Train the boosters for some iterations.</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>num_iterations</td>
<td>int</td>
<td></td>
<td>Number of boosting iterations to run</td>
</tr>
<tr class="even">
<td>before_predict_callback</td>
<td>typing.Optional[typing.Callable]</td>
<td>None</td>
<td>Function to call on the features before computing the predictions.<br> This function will take the input dataframe that will be passed to the model for predicting and should return a dataframe with the same structure.<br> The series identifier is on the index.</td>
</tr>
<tr class="odd">
<td>after_predict_callback</td>
<td>typing.Optional[typing.Callable]</td>
<td>None</td>
<td>Function to call on the predictions before updating the targets.<br> This function will take a pandas Series with the predictions and should return another one with the same structure.<br> The series identifier is on the index.</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>float</strong></td>
<td></td>
<td><strong>Weighted metric after training for num_iterations.</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>score <span class="op">=</span> cv4.partial_fit(<span class="dv">10</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>score</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[LightGBM] [Info] Start training from score 51.745632</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>0.5906900462828166</code></pre>
</div>
</div>
<p>This is equal to the first evaluation from our first example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> hist[<span class="dv">0</span>][<span class="dv">1</span>] <span class="op">==</span> score</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now use this score to decide if this configuration is promising. If we want to we can train some more iterations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>score2 <span class="op">=</span> cv4.partial_fit(<span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is now equal to our third metric from the first example, since this time we trained for 20 iterations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> hist[<span class="dv">2</span>][<span class="dv">1</span>] <span class="op">==</span> score2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="using-a-custom-metric" class="level3">
<h3 class="anchored" data-anchor-id="using-a-custom-metric">Using a custom metric</h3>
<p>The built-in metrics are MAPE and RMSE, which are computed by serie and then averaged across all series. If you want to do something different or use a different metric entirely, you can define your own metric like the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> weighted_mape(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    y_true: pd.Series,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    y_pred: pd.Series,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    ids: pd.Series,</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    dates: pd.Series,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Weighs the MAPE by the magnitude of the series values"""</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    abs_pct_err <span class="op">=</span> <span class="bu">abs</span>(y_true <span class="op">-</span> y_pred) <span class="op">/</span> <span class="bu">abs</span>(y_true)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    mape_by_serie <span class="op">=</span> abs_pct_err.groupby(ids).mean()</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    totals_per_serie <span class="op">=</span> y_pred.groupby(ids).<span class="bu">sum</span>()</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    series_weights <span class="op">=</span> totals_per_serie <span class="op">/</span> totals_per_serie.<span class="bu">sum</span>()</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (mape_by_serie <span class="op">*</span> series_weights).<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> LightGBMCV(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    freq<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    lags<span class="op">=</span>[<span class="dv">24</span> <span class="op">*</span> (i<span class="op">+</span><span class="dv">1</span>) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">7</span>)],</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>).fit(</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    train,</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    n_windows<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    h<span class="op">=</span>horizon,</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    params<span class="op">=</span>{<span class="st">'verbose'</span>: <span class="op">-</span><span class="dv">1</span>},</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    metric<span class="op">=</span>weighted_mape,</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[LightGBM] [Info] Start training from score 51.745632
[10] weighted_mape: 0.480353
[20] weighted_mape: 0.218670
[30] weighted_mape: 0.161706
[40] weighted_mape: 0.149992
[50] weighted_mape: 0.149024
[60] weighted_mape: 0.148496
Early stopping at round 60
Using best iteration: 60</code></pre>
</div>
</div>


</section>
</section>

<p>Give us a ‚≠ê on <a href="https://github.com/nixtla/mlforecast">Github</a></p></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>